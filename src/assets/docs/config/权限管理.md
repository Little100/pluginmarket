# Minecraft 服务器权限管理指南

## 概述

### 什么是权限管理

权限管理是 Minecraft 服务器运营中的核心功能之一。它决定了玩家在服务器中能够执行哪些操作、使用哪些命令、访问哪些区域。

一个完善的权限系统可以：
- 保护服务器免受恶意破坏
- 区分不同等级的玩家（普通玩家、VIP、管理员等）
- 精确控制每个功能的使用权限
- 实现多服务器之间的权限同步

### 为什么需要权限管理

在没有权限管理的情况下，服务器会面临以下问题：
- 所有玩家都能使用所有命令，包括危险命令
- 无法区分管理员和普通玩家
- 无法实现 VIP 等级系统
- 服务器安全无法得到保障

---

## 原版权限系统

Minecraft 原版提供了一套基础的权限系统，通过 OP（Operator，管理员）机制实现。

### OP 等级说明

原版 OP 分为 4 个等级，每个等级拥有不同的权限：

| 等级 | 权限范围 |
|------|----------|
| 1 级 | 可以绕过出生点保护 |
| 2 级 | 可以使用单人游戏作弊命令（/clear、/difficulty、/gamemode、/give 等）和命令方块 |
| 3 级 | 可以使用多人游戏管理命令（/ban、/kick、/op 等） |
| 4 级 | 可以使用所有命令，包括 /stop、/reload 等服务器管理命令 |

### ops.json 文件

服务器的 OP 列表存储在服务器根目录的 `ops.json` 文件中：

```json
[
  {
    "uuid": "玩家UUID",
    "name": "玩家名称",
    "level": 4,
    "bypassesPlayerLimit": false
  }
]
```

字段说明：
- `uuid`：玩家的唯一标识符
- `name`：玩家名称
- `level`：OP 等级（1-4）
- `bypassesPlayerLimit`：是否可以在服务器满员时加入

### 相关命令

```bash
# 给予玩家 OP 权限（默认 4 级）
/op <玩家名>

# 移除玩家 OP 权限
/deop <玩家名>
```

在 `server.properties` 中可以设置默认 OP 等级：
```properties
op-permission-level=4
```

### 原版权限系统的局限性

原版权限系统存在明显的不足：

1. **粒度太粗**：只有 4 个等级，无法精确控制单个命令的权限
2. **无法分组**：不能创建自定义的权限组（如 VIP、Builder 等）
3. **全有或全无**：要么是 OP 拥有大量权限，要么是普通玩家几乎没有权限
4. **无法跨服同步**：多服务器环境下需要分别设置
5. **无法设置前后缀**：不能在聊天中显示玩家等级标识

因此，大多数服务器都会使用专门的权限管理插件。

---

## LuckPerms（推荐）

LuckPerms 是目前最主流、功能最强大的权限管理插件，被广泛应用于各类 Minecraft 服务器。

### 简介

LuckPerms 的主要特点：
- 完全开源免费
- 支持几乎所有服务端平台
- 提供强大的 Web 编辑器
- 支持多种数据库存储
- 支持群组服权限同步
- 活跃的开发和社区支持

### 支持平台

| 平台 | 支持版本 |
|------|----------|
| Bukkit/Spigot/Paper | 1.8.8 - 最新版 |
| BungeeCord | 全版本 |
| Velocity | 全版本 |
| Fabric | 1.16+ |
| Forge | 1.16+ |
| Sponge | API 7/8 |

### 安装方法

1. 从官方网站下载对应平台的插件：https://luckperms.net/download
2. 将下载的 jar 文件放入服务器的 `plugins` 文件夹
3. 重启服务器
4. 插件会自动生成配置文件

### 基本概念

#### 权限节点

权限节点是权限系统的基础单位，通常采用点分隔的格式：

```
插件名.功能.子功能
```

示例：
- `essentials.home` - 使用 /home 命令
- `essentials.home.set` - 使用 /sethome 命令
- `worldedit.selection.pos` - 使用 WorldEdit 选区功能

#### 组（Group）

组是一组权限的集合，可以将多个权限打包在一起，然后分配给玩家。

常见的组设计：
- `default` - 默认组，所有新玩家自动加入
- `vip` - VIP 玩家组
- `builder` - 建筑师组
- `mod` - 管理员组
- `admin` - 超级管理员组

#### 继承

组可以继承其他组的权限。例如：
- `vip` 继承 `default`，拥有默认组的所有权限 + VIP 专属权限
- `admin` 继承 `mod`，拥有管理员的所有权限 + 超管专属权限

#### 权重

当玩家属于多个组时，权重决定了哪个组的设置优先生效。权重数值越高，优先级越高。

### 常用命令

#### 用户权限管理

```bash
# 给玩家设置权限
/lp user <玩家> permission set <权限节点> true

# 移除玩家权限
/lp user <玩家> permission set <权限节点> false

# 取消设置（恢复继承）
/lp user <玩家> permission unset <权限节点>

# 查看玩家权限
/lp user <玩家> permission info

# 将玩家设置到指定组
/lp user <玩家> parent set <组名>

# 给玩家添加额外的组
/lp user <玩家> parent add <组名>

# 从玩家移除组
/lp user <玩家> parent remove <组名>
```

#### 组权限管理

```bash
# 给组设置权限
/lp group <组名> permission set <权限节点> true

# 移除组权限
/lp group <组名> permission set <权限节点> false

# 设置组的父组（继承）
/lp group <组名> parent add <父组名>

# 移除继承关系
/lp group <组名> parent remove <父组名>

# 创建新组
/lp creategroup <组名>

# 删除组
/lp deletegroup <组名>

# 查看组信息
/lp group <组名> info
```

#### Web 编辑器（重点推荐）

LuckPerms 提供了强大的 Web 编辑器，可以通过可视化界面管理权限：

```bash
# 打开 Web 编辑器
/lp editor

# 打开特定用户的编辑器
/lp user <玩家> editor

# 打开特定组的编辑器
/lp group <组名> editor
```

执行命令后会生成一个链接，在浏览器中打开即可使用。Web 编辑器的优势：
- 可视化操作，无需记忆命令
- 支持搜索和批量编辑
- 可以查看权限继承关系
- 编辑完成后一键应用更改

### 默认组配置

新玩家加入服务器时会自动分配到默认组。配置文件位于 `plugins/LuckPerms/config.yml`：

```yaml
# 默认组名称
default-group: default
```

为默认组设置基础权限：

```bash
# 基础聊天权限
/lp group default permission set essentials.chat true

# 基础传送权限
/lp group default permission set essentials.spawn true
/lp group default permission set essentials.home true
/lp group default permission set essentials.sethome true

# 基础信息查看
/lp group default permission set essentials.help true
/lp group default permission set essentials.list true
```

### 前后缀设置

LuckPerms 支持为玩家和组设置前后缀，需要配合 Vault 和聊天插件使用。

```bash
# 设置组前缀
/lp group <组名> meta setprefix <优先级> "<前缀>"

# 示例：设置 VIP 组前缀
/lp group vip meta setprefix 100 "&6[VIP] "

# 设置组后缀
/lp group <组名> meta setsuffix <优先级> "<后缀>"

# 设置玩家个人前缀
/lp user <玩家> meta setprefix 200 "&c[Owner] "
```

颜色代码参考：
- `&0` 黑色 | `&1` 深蓝 | `&2` 深绿 | `&3` 深青
- `&4` 深红 | `&5` 紫色 | `&6` 金色 | `&7` 灰色
- `&8` 深灰 | `&9` 蓝色 | `&a` 绿色 | `&b` 青色
- `&c` 红色 | `&d` 粉色 | `&e` 黄色 | `&f` 白色
- `&l` 粗体 | `&o` 斜体 | `&n` 下划线 | `&r` 重置

### 存储方式

LuckPerms 支持多种数据存储方式，在 `config.yml` 中配置：

#### H2（默认）

```yaml
storage-method: H2
```

H2 是一个嵌入式数据库，无需额外配置，适合单服务器使用。数据存储在 `plugins/LuckPerms/luckperms-h2.mv.db` 文件中。

#### MySQL / MariaDB

适合群组服或需要外部数据库的场景：

```yaml
storage-method: MySQL

data:
  address: localhost:3306
  database: luckperms
  username: root
  password: your_password
  pool-settings:
    maximum-pool-size: 10
    minimum-idle: 10
    maximum-lifetime: 1800000
    connection-timeout: 5000
```

#### PostgreSQL

```yaml
storage-method: PostgreSQL

data:
  address: localhost:5432
  database: luckperms
  username: postgres
  password: your_password
```

#### SQLite

```yaml
storage-method: SQLite
```

数据存储在 `plugins/LuckPerms/luckperms-sqlite.db` 文件中。

### 群组服同步配置

在群组服（BungeeCord/Velocity）环境下，需要配置权限同步：

#### 1. 所有子服使用相同的数据库

确保所有服务器的 `config.yml` 中数据库配置完全相同。

#### 2. 启用消息同步

在 `config.yml` 中配置：

```yaml
# 启用消息服务
messaging-service: sql

# 或使用 Redis（推荐大型服务器）
messaging-service: redis
redis:
  address: localhost:6379
  password: ''
```

#### 3. 同步设置

```yaml
# 自动同步权限更改
watch-files: true

# 同步间隔（毫秒）
sync-minutes: 3
```

---

## Vault

### 什么是 Vault

Vault 是一个权限、聊天和经济系统的 API 桥接插件。它本身不提供任何功能，而是作为中间层，让其他插件能够与权限插件和经济插件进行交互。

### 为什么需要 Vault

许多插件需要检查玩家权限或获取玩家前缀，但不同的权限插件有不同的 API。Vault 提供了统一的接口：

- 聊天插件通过 Vault 获取玩家前缀/后缀
- 商店插件通过 Vault 操作玩家金币
- 其他插件通过 Vault 检查玩家权限组

### 安装方法

1. 下载 Vault：https://www.spigotmc.org/resources/vault.34315/
2. 放入 `plugins` 文件夹
3. 重启服务器
4. 确保已安装权限插件（如 LuckPerms）

Vault 会自动检测并连接已安装的权限插件。

---

## 权限设计最佳实践

### 组的层级设计

推荐采用层级继承的组结构：

```
default（默认组）
    ↓
  vip（VIP 玩家）
    ↓
  mvp（高级 VIP）
    ↓
  helper（助手）
    ↓
  mod（管理员）
    ↓
  admin（超级管理员）
```

创建示例：

```bash
# 创建组
/lp creategroup vip
/lp creategroup mvp
/lp creategroup helper
/lp creategroup mod
/lp creategroup admin

# 设置继承关系
/lp group vip parent add default
/lp group mvp parent add vip
/lp group helper parent add mvp
/lp group mod parent add helper
/lp group admin parent add mod

# 设置权重（数值越高优先级越高）
/lp group default meta setweight 0
/lp group vip meta setweight 10
/lp group mvp meta setweight 20
/lp group helper meta setweight 50
/lp group mod meta setweight 80
/lp group admin meta setweight 100
```

### 权限节点的通配符

LuckPerms 支持使用通配符批量设置权限：

```bash
# 授予 essentials 的所有权限
/lp group admin permission set essentials.* true

# 授予 worldedit 的所有权限
/lp group admin permission set worldedit.* true

# 授予所有权限（谨慎使用）
/lp group admin permission set * true
```

注意事项：
- 通配符权限可能授予意料之外的权限
- 建议仅对管理员组使用通配符
- 普通玩家应逐个设置具体权限

### 最小权限原则

权限设计应遵循最小权限原则：

1. **默认拒绝**：不明确授予的权限默认为拒绝
2. **按需授予**：只给予完成任务所需的最小权限
3. **定期审查**：定期检查权限设置，移除不必要的权限
4. **分离职责**：不同职责使用不同的权限组

示例：建筑师组只需要建筑相关权限

```bash
/lp group builder permission set worldedit.wand true
/lp group builder permission set worldedit.selection.* true
/lp group builder permission set worldedit.region.* true
/lp group builder permission set worldedit.clipboard.* true
# 不给予 //regen、//chunk 等危险命令
```

---

## 常见权限节点示例

### Essentials 常用权限

```bash
# 基础命令
essentials.help          # /help 命令
essentials.list          # /list 查看在线玩家
essentials.motd          # 查看服务器公告
essentials.rules         # 查看服务器规则
essentials.spawn         # /spawn 回到出生点
essentials.suicide       # /suicide 自杀

# 传送相关
essentials.home          # /home 回家
essentials.sethome       # /sethome 设置家
essentials.delhome       # /delhome 删除家
essentials.tpa           # /tpa 请求传送
essentials.tpaccept      # /tpaccept 接受传送
essentials.tpdeny        # /tpdeny 拒绝传送
essentials.back          # /back 返回上一位置
essentials.warp          # /warp 传送到地标
essentials.setwarp       # /setwarp 设置地标（管理员）

# 经济相关
essentials.balance       # /bal 查看余额
essentials.pay           # /pay 转账
essentials.baltop        # /baltop 查看财富榜

# 管理命令
essentials.kick          # /kick 踢出玩家
essentials.ban           # /ban 封禁玩家
essentials.mute          # /mute 禁言玩家
essentials.gamemode      # /gamemode 切换游戏模式
essentials.fly           # /fly 飞行
essentials.god           # /god 无敌模式
essentials.heal          # /heal 治疗
essentials.feed          # /feed 喂食
```

### WorldEdit 权限

```bash
# 选区工具
worldedit.wand                    # 使用木斧选区
worldedit.selection.pos           # //pos1 //pos2 命令
worldedit.selection.chunk         # //chunk 选择区块
worldedit.selection.expand        # //expand 扩展选区
worldedit.selection.contract      # //contract 收缩选区

# 区域操作
worldedit.region.set              # //set 填充方块
worldedit.region.replace          # //replace 替换方块
worldedit.region.walls            # //walls 创建墙壁
worldedit.region.faces            # //faces 创建外壳
worldedit.region.smooth           # //smooth 平滑地形
worldedit.region.move             # //move 移动区域
worldedit.region.stack            # //stack 堆叠区域

# 剪贴板
worldedit.clipboard.copy          # //copy 复制
worldedit.clipboard.cut           # //cut 剪切
worldedit.clipboard.paste         # //paste 粘贴
worldedit.clipboard.rotate        # //rotate 旋转
worldedit.clipboard.flip          # //flip 翻转
worldedit.schematic.save          # //schem save 保存原理图
worldedit.schematic.load          # //schem load 加载原理图

# 历史记录
worldedit.history.undo            # //undo 撤销
worldedit.history.redo            # //redo 重做
```

### 基础权限配置示例

以下是一个完整的权限组配置示例：

```bash
# === 默认组 ===
/lp group default permission set essentials.help true
/lp group default permission set essentials.list true
/lp group default permission set essentials.spawn true
/lp group default permission set essentials.home true
/lp group default permission set essentials.sethome true
/lp group default permission set essentials.tpa true
/lp group default permission set essentials.tpaccept true
/lp group default permission set essentials.tpdeny true
/lp group default permission set essentials.balance true
/lp group default permission set essentials.pay true
/lp group default meta setprefix 10 "&7"

# === VIP 组 ===
/lp group vip parent add default
/lp group vip permission set essentials.back true
/lp group vip permission set essentials.workbench true
/lp group vip permission set essentials.enderchest true
/lp group vip permission set essentials.sethome.multiple.vip true
/lp group vip meta setprefix 20 "&6[VIP] "

# === 管理员组 ===
/lp group mod parent add vip
/lp group mod permission set essentials.kick true
/lp group mod permission set essentials.mute true
/lp group mod permission set essentials.tp true
/lp group mod permission set essentials.tphere true
/lp group mod permission set essentials.vanish true
/lp group mod permission set essentials.invsee true
/lp group mod permission set worldedit.wand true
/lp group mod permission set worldedit.selection.* true
/lp group mod meta setprefix 80 "&c[MOD] "

# === 超级管理员组 ===
/lp group admin parent add mod
/lp group admin permission set * true
/lp group admin meta setprefix 100 "&4[ADMIN] "
```

---

## 常见问题

### 权限不生效

1. 检查权限节点是否正确（区分大小写）
2. 使用 `/lp user <玩家> permission check <权限>` 检查权限状态
3. 检查是否有否定权限覆盖了正向权限
4. 确认玩家所在的组是否正确

### 前缀不显示

1. 确认已安装 Vault
2. 确认聊天插件支持 Vault（如 EssentialsChat、DeluxeChat）
3. 检查前缀格式是否正确
4. 使用 `/lp user <玩家> meta info` 查看前缀设置

### 群组服权限不同步

1. 确认所有服务器使用相同的数据库配置
2. 检查 messaging-service 是否正确配置
3. 确认数据库连接正常
4. 尝试执行 `/lp sync` 手动同步

---

## 相关资源

- LuckPerms 官网：https://luckperms.net/
- LuckPerms Wiki：https://luckperms.net/wiki
- LuckPerms Web 编辑器：https://luckperms.net/editor
- Vault 下载：https://www.spigotmc.org/resources/vault.34315/

