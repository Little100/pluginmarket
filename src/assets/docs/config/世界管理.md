# 世界管理

## 概述

Minecraft 服务器的世界是游戏内容的核心载体，包含了地形、建筑、实体和玩家数据等所有信息。一个标准的 Minecraft 服务器默认包含三个维度：主世界（Overworld）、下界（Nether）和末地（The End）。

服务器管理员需要掌握世界管理的相关知识，包括：
- 理解世界的目录结构和文件组成
- 使用多世界插件创建和管理多个世界
- 设置世界边界控制地图大小
- 预生成世界区块以提升服务器性能
- 导入外部地图和重置世界

## 世界目录结构

### 默认世界文件夹

Minecraft 服务器在首次启动时会自动生成世界文件。不同的服务端核心对世界文件夹的组织方式略有不同。

**Vanilla/Spigot/Paper 服务端：**

```
server/
├── world/                    # 主世界
│   ├── region/              # 主世界区块数据
│   ├── entities/            # 实体数据（1.17+）
│   ├── poi/                 # 兴趣点数据（村民工作站等）
│   ├── playerdata/          # 玩家数据
│   ├── data/                # 地图数据、结构数据等
│   ├── datapacks/           # 数据包
│   ├── DIM-1/               # 下界维度数据
│   │   ├── region/
│   │   └── entities/
│   ├── DIM1/                # 末地维度数据
│   │   ├── region/
│   │   └── entities/
│   └── level.dat            # 世界配置文件
```

**Bukkit 系服务端（Spigot/Paper 等）的独立维度文件夹：**

Bukkit 系服务端会将下界和末地分离为独立的文件夹：

```
server/
├── world/                    # 主世界
│   ├── region/
│   ├── playerdata/
│   ├── data/
│   └── level.dat
├── world_nether/             # 下界（独立文件夹）
│   ├── DIM-1/
│   │   └── region/
│   └── level.dat
└── world_the_end/            # 末地（独立文件夹）
    ├── DIM1/
    │   └── region/
    └── level.dat
```

### 重要文件和文件夹说明

| 文件/文件夹 | 说明 |
|------------|------|
| `region/` | 存储区块数据的文件夹，包含 `.mca` 格式的区域文件 |
| `entities/` | 存储实体数据（1.17+ 版本独立出来） |
| `poi/` | Point of Interest，存储村民工作站、蜂巢等兴趣点 |
| `playerdata/` | 玩家数据，每个玩家一个 UUID 命名的 `.dat` 文件 |
| `data/` | 存储地图物品数据、结构数据、突袭数据等 |
| `level.dat` | 世界的核心配置文件，包含种子、游戏规则、时间等 |
| `level.dat_old` | `level.dat` 的备份文件 |
| `session.lock` | 会话锁定文件，防止世界被多个进程同时访问 |
| `DIM-1/` | 下界维度数据（-1 代表下界的维度 ID） |
| `DIM1/` | 末地维度数据（1 代表末地的维度 ID） |

### Region 文件格式

`region/` 文件夹中的 `.mca` 文件采用 Anvil 格式存储区块数据。每个 `.mca` 文件存储 32×32 个区块（512×512 方块）的数据。

文件命名规则：`r.X.Z.mca`
- `X` 和 `Z` 是区域坐标
- 区域坐标 = 区块坐标 ÷ 32（向下取整）
- 区块坐标 = 方块坐标 ÷ 16（向下取整）

例如，坐标 (1000, 2000) 处的方块：
- 区块坐标：(62, 125)
- 区域坐标：(1, 3)
- 对应文件：`r.1.3.mca`

## 多世界管理

默认情况下，服务器只有一个世界（包含三个维度）。如果需要创建多个独立的世界，需要使用多世界管理插件。

### Multiverse-Core

Multiverse-Core 是最经典、使用最广泛的多世界管理插件，支持创建、删除、管理多个世界。

**安装：**

1. 从 [SpigotMC](https://www.spigotmc.org/resources/multiverse-core.390/) 或 [Modrinth](https://modrinth.com/plugin/multiverse-core) 下载插件
2. 将 `.jar` 文件放入 `plugins/` 文件夹
3. 重启服务器

**基本命令：**

| 命令 | 说明 |
|------|------|
| `/mv list` | 列出所有世界 |
| `/mv info [世界名]` | 查看世界信息 |
| `/mv tp <世界名>` | 传送到指定世界 |
| `/mv create <世界名> <环境>` | 创建新世界 |
| `/mv delete <世界名>` | 删除世界（需要确认） |
| `/mv remove <世界名>` | 从 Multiverse 中移除世界（不删除文件） |
| `/mv import <世界名> <环境>` | 导入已存在的世界 |
| `/mv load <世界名>` | 加载世界 |
| `/mv unload <世界名>` | 卸载世界 |
| `/mv setspawn` | 设置当前位置为世界出生点 |
| `/mv spawn [世界名]` | 传送到世界出生点 |

**创建世界：**

```bash
# 创建普通主世界
/mv create myworld NORMAL

# 创建下界类型世界
/mv create mynether NETHER

# 创建末地类型世界
/mv create myend END

# 创建超平坦世界
/mv create flatworld NORMAL -t FLAT

# 使用指定种子创建世界
/mv create myworld NORMAL -s 12345678

# 使用自定义生成器创建世界
/mv create terraworld NORMAL -g Terra:OVERWORLD
```

**世界环境类型：**

| 环境类型 | 说明 |
|---------|------|
| `NORMAL` | 主世界环境，正常的天空和光照 |
| `NETHER` | 下界环境，红色天空，无法使用床 |
| `END` | 末地环境，深色天空，无法使用床 |

**世界类型（-t 参数）：**

| 世界类型 | 说明 |
|---------|------|
| `NORMAL` | 默认世界生成 |
| `FLAT` | 超平坦世界 |
| `LARGE_BIOMES` | 大型生物群系 |
| `AMPLIFIED` | 放大化地形 |

**世界配置：**

Multiverse 的世界配置存储在 `plugins/Multiverse-Core/worlds.yml` 文件中。可以配置的选项包括：

```yaml
worlds:
  myworld:
    # 世界别名（显示名称）
    alias: '&a我的世界'
    # 游戏模式：SURVIVAL, CREATIVE, ADVENTURE, SPECTATOR
    gamemode: SURVIVAL
    # 难度：PEACEFUL, EASY, NORMAL, HARD
    difficulty: NORMAL
    # 是否允许 PvP
    pvp: true
    # 是否允许怪物生成
    monsters: true
    # 是否允许动物生成
    animals: true
    # 出生点位置
    spawn:
      x: 0.0
      y: 64.0
      z: 0.0
    # 是否自动加载
    autoload: true
    # 进入世界所需权限
    permission: multiverse.access.myworld
```

### Multiverse-Portals

Multiverse-Portals 是 Multiverse 的扩展插件，用于创建自定义传送门。

**安装：**

需要先安装 Multiverse-Core，然后下载 Multiverse-Portals 放入 `plugins/` 文件夹。

**创建传送门：**

1. 使用木斧选择传送门区域的两个对角点：
   ```
   /mvp wand
   ```

2. 左键点击第一个角，右键点击第二个角

3. 创建传送门：
   ```
   /mvp create <传送门名称> <目标世界>
   ```

**传送门命令：**

| 命令 | 说明 |
|------|------|
| `/mvp wand` | 获取选区工具 |
| `/mvp create <名称> <目标>` | 创建传送门 |
| `/mvp remove <名称>` | 删除传送门 |
| `/mvp list` | 列出所有传送门 |
| `/mvp info <名称>` | 查看传送门信息 |
| `/mvp modify <名称> dest <目标>` | 修改传送门目标 |

### Multiverse-NetherPortals

Multiverse-NetherPortals 用于配置不同世界之间的下界传送门链接关系。

默认情况下，在 `world` 中进入下界传送门会到达 `world_nether`。使用此插件可以自定义这种链接关系。

**配置示例（config.yml）：**

```yaml
# 世界链接配置
worlds:
  # 在 creative 世界进入下界传送门
  creative:
    # 会传送到 creative_nether
    nether: creative_nether
  # 在 creative_nether 进入下界传送门
  creative_nether:
    # 会返回 creative
    nether: creative
```

**命令：**

| 命令 | 说明 |
|------|------|
| `/mvnp link <主世界> <下界世界>` | 链接主世界和下界 |
| `/mvnp unlink <世界>` | 取消世界链接 |
| `/mvnp show` | 显示所有链接关系 |

## 世界边界

世界边界用于限制玩家可探索的区域范围。设置合理的世界边界可以：
- 控制地图文件大小，节省磁盘空间
- 防止玩家过度探索导致服务器生成大量区块
- 配合预生成功能，确保所有可访问区域都已预生成

### 原版 /worldborder 命令

Minecraft 原版提供了世界边界功能，通过 `/worldborder` 命令控制。

**基本命令：**

| 命令 | 说明 |
|------|------|
| `/worldborder center <x> <z>` | 设置边界中心点 |
| `/worldborder set <直径>` | 设置边界大小（方块） |
| `/worldborder set <直径> <时间>` | 在指定时间内渐变到目标大小 |
| `/worldborder add <距离>` | 增加边界大小 |
| `/worldborder add <距离> <时间>` | 在指定时间内增加边界大小 |
| `/worldborder get` | 获取当前边界大小 |
| `/worldborder damage amount <伤害>` | 设置越界伤害（每方块每秒） |
| `/worldborder damage buffer <距离>` | 设置伤害缓冲区距离 |
| `/worldborder warning distance <距离>` | 设置警告距离（屏幕变红） |
| `/worldborder warning time <秒>` | 设置警告时间 |

**使用示例：**

```bash
# 将边界中心设置为坐标原点
/worldborder center 0 0

# 设置边界直径为 10000 方块（半径 5000）
/worldborder set 10000

# 在 60 秒内将边界缩小到 5000 方块
/worldborder set 5000 60

# 设置越界后每秒每方块受到 0.2 点伤害
/worldborder damage amount 0.2

# 设置边界外 5 格开始受到伤害
/worldborder damage buffer 5

# 距离边界 10 格时屏幕开始变红警告
/worldborder warning distance 10
```

**注意事项：**
- 原版世界边界是圆角正方形
- 边界大小以直径计算，不是半径
- 每个维度的世界边界是独立的
- 世界边界会阻止玩家通过，但不会阻止投掷物

### WorldBorder 插件

对于需要更多功能的服务器，可以使用 WorldBorder 插件。

**安装：**

从 [SpigotMC](https://www.spigotmc.org/resources/worldborder.60905/) 下载并放入 `plugins/` 文件夹。

**主要功能：**
- 支持圆形边界
- 可以为每个世界单独设置边界
- 集成区块预生成功能
- 支持边界形状自定义

**基本命令：**

| 命令 | 说明 |
|------|------|
| `/wb set <半径>` | 设置当前世界的边界半径 |
| `/wb set <半径> <x> <z>` | 设置边界半径和中心点 |
| `/wb <世界名> set <半径>` | 为指定世界设置边界 |
| `/wb shape <round/square>` | 设置边界形状 |
| `/wb list` | 列出所有世界的边界设置 |
| `/wb clear` | 清除当前世界的边界 |
| `/wb fill` | 开始预生成边界内的区块 |
| `/wb fill confirm` | 确认开始预生成 |

**配置示例：**

```bash
# 设置主世界边界，半径 5000，中心点 (0, 0)
/wb world set 5000 0 0

# 设置下界边界（下界坐标是主世界的 1/8）
/wb world_nether set 625 0 0

# 设置为圆形边界
/wb shape round

# 开始预生成
/wb fill
```

### 边界大小建议

| 服务器类型 | 建议半径 | 说明 |
|-----------|---------|------|
| 小型生存服 | 2500-5000 | 适合 10-30 人的小型服务器 |
| 中型生存服 | 5000-10000 | 适合 30-100 人的服务器 |
| 大型生存服 | 10000-15000 | 适合 100+ 人的服务器 |
| 资源世界 | 2000-3000 | 定期重置的资源采集世界 |
| 小游戏地图 | 根据地图大小 | 通常 100-500 |

## 预生成世界

### 为什么需要预生成

当玩家探索新区域时，服务器需要实时生成区块。区块生成是一个计算密集型操作，会消耗大量 CPU 资源，可能导致：
- 服务器 TPS 下降
- 玩家移动时出现卡顿
- 区块加载延迟

预生成是指在服务器空闲时提前生成所有可能被访问的区块，将区块数据保存到磁盘。当玩家访问这些区域时，服务器只需从磁盘读取数据，而不需要实时计算生成。

### Chunky 插件

Chunky 是目前最推荐的区块预生成插件，性能优秀，功能完善。

**安装：**

从 [Modrinth](https://modrinth.com/plugin/chunky) 或 [SpigotMC](https://www.spigotmc.org/resources/chunky.81534/) 下载。

**基本命令：**

| 命令 | 说明 |
|------|------|
| `/chunky start` | 开始预生成 |
| `/chunky pause` | 暂停预生成 |
| `/chunky continue` | 继续预生成 |
| `/chunky cancel` | 取消预生成任务 |
| `/chunky world <世界名>` | 选择要预生成的世界 |
| `/chunky center <x> <z>` | 设置预生成中心点 |
| `/chunky radius <半径>` | 设置预生成半径 |
| `/chunky shape <形状>` | 设置预生成形状 |
| `/chunky pattern <模式>` | 设置生成模式 |
| `/chunky quiet <间隔>` | 设置进度消息间隔 |
| `/chunky progress` | 查看当前进度 |

**预生成形状：**

| 形状 | 说明 |
|------|------|
| `square` | 正方形（默认） |
| `circle` | 圆形 |
| `rectangle` | 矩形（需要额外设置） |
| `oval` | 椭圆形 |

**使用示例：**

```bash
# 选择主世界
/chunky world world

# 设置中心点为原点
/chunky center 0 0

# 设置半径为 5000 方块
/chunky radius 5000

# 使用圆形区域
/chunky shape circle

# 开始预生成
/chunky start

# 查看进度
/chunky progress

# 暂停预生成（服务器繁忙时）
/chunky pause

# 继续预生成
/chunky continue
```

**预生成下界和末地：**

```bash
# 预生成下界（半径通常是主世界的 1/8）
/chunky world world_nether
/chunky center 0 0
/chunky radius 625
/chunky start

# 预生成末地
/chunky world world_the_end
/chunky center 0 0
/chunky radius 2000
/chunky start
```

### 预生成注意事项

**磁盘空间估算：**

预生成的区块会占用大量磁盘空间。粗略估算：
- 每个区块约 4-8 KB
- 半径 5000 方块 ≈ 312×312 个区块 ≈ 400-800 MB
- 半径 10000 方块 ≈ 625×625 个区块 ≈ 1.5-3 GB

实际大小取决于地形复杂度、生物群系类型等因素。

**时间估算：**

预生成速度取决于服务器性能和配置：
- 普通服务器：每秒 50-200 个区块
- 高性能服务器：每秒 200-500 个区块

半径 5000 方块（约 97,000 个区块）：
- 普通服务器：8-30 分钟
- 高性能服务器：3-8 分钟

**最佳实践：**

1. **在服务器空闲时预生成**：避免在玩家活跃时进行预生成
2. **分批预生成**：如果区域很大，可以分多次完成
3. **监控服务器性能**：使用 `/tps` 命令监控，TPS 过低时暂停
4. **预留足够磁盘空间**：确保有足够的存储空间
5. **配合世界边界使用**：预生成范围应与世界边界一致

## 地图导入

### 导入单人存档

将单人游戏的存档导入到服务器：

1. **找到单人存档位置**：
   - Windows：`%appdata%\.minecraft\saves\<存档名称>`
   - macOS：`~/Library/Application Support/minecraft/saves/<存档名称>`
   - Linux：`~/.minecraft/saves/<存档名称>`

2. **复制存档文件夹**：
   将整个存档文件夹复制到服务器目录

3. **重命名文件夹**（可选）：
   将文件夹重命名为 `world`（或在 `server.properties` 中修改 `level-name`）

4. **处理玩家数据**：
   单人存档的玩家数据存储在 `level.dat` 中，而服务器使用 `playerdata/` 文件夹。首次进入服务器时，玩家会以新玩家身份出生在出生点。

5. **启动服务器**：
   服务器会自动加载世界

**使用 Multiverse 导入：**

如果使用 Multiverse 管理多世界，可以使用导入命令：

```bash
# 将存档文件夹放入服务器根目录后
/mv import <文件夹名称> NORMAL
```

### 导入下载的地图

从网上下载的地图（如冒险地图、小游戏地图）导入方法：

1. **下载并解压地图**：
   确保解压后得到包含 `level.dat` 的文件夹

2. **检查地图结构**：
   ```
   地图文件夹/
   ├── level.dat          # 必须存在
   ├── region/            # 区块数据
   ├── data/              # 可选
   └── ...
   ```

3. **复制到服务器目录**：
   将地图文件夹复制到服务器根目录

4. **导入地图**：
   ```bash
   # 使用 Multiverse 导入
   /mv import <地图文件夹名> NORMAL
   
   # 如果是下界类型地图
   /mv import <地图文件夹名> NETHER
   
   # 如果是末地类型地图
   /mv import <地图文件夹名> END
   ```

### 导入注意事项

1. **版本兼容性**：
   - 高版本地图无法在低版本服务器运行
   - 低版本地图可以在高版本服务器运行，但会自动升级格式
   - 升级后的地图无法回退到低版本

2. **数据包兼容性**：
   - 检查地图是否依赖特定数据包
   - 将 `datapacks/` 文件夹中的数据包一并复制

3. **模组兼容性**：
   - 如果地图使用了模组，服务器也需要安装相同的模组
   - 纯原版地图可以在任何服务端运行

4. **权限和游戏规则**：
   - 导入后检查游戏规则设置
   - 冒险地图可能需要特定的游戏规则配置

5. **出生点设置**：
   ```bash
   # 导入后设置出生点
   /mv setspawn
   
   # 或使用原版命令
   /setworldspawn <x> <y> <z>
   ```

## 世界重置

### 安全重置世界

重置世界前务必做好备份，以下是安全的重置步骤：

**方法一：删除世界文件夹**

1. **停止服务器**

2. **备份世界**（重要）：
   ```bash
   # Windows
   xcopy /E /I world world_backup_%date:~0,10%
   
   # Linux/macOS
   cp -r world world_backup_$(date +%Y%m%d)
   ```

3. **删除世界文件夹**：
   删除 `world/`、`world_nether/`、`world_the_end/` 文件夹

4. **启动服务器**：
   服务器会自动生成新世界

**方法二：使用 Multiverse**

```bash
# 删除世界（会要求确认）
/mv delete <世界名>
/mv confirm

# 重新创建世界
/mv create <世界名> NORMAL
```

**方法三：保留玩家数据重置**

如果只想重置地形，保留玩家数据：

1. 备份 `world/playerdata/` 文件夹
2. 删除世界文件夹
3. 启动服务器生成新世界
4. 停止服务器
5. 将备份的 `playerdata/` 复制回 `world/playerdata/`
6. 启动服务器

### 定期重置资源世界

许多服务器会设置一个专门的"资源世界"供玩家采集资源，定期重置以保持资源充足。

**手动重置方案：**

1. 创建专门的资源世界：
   ```bash
   /mv create resource NORMAL
   ```

2. 定期执行重置：
   ```bash
   # 删除旧的资源世界
   /mv delete resource
   /mv confirm
   
   # 创建新的资源世界
   /mv create resource NORMAL
   
   # 设置世界边界
   /worldborder center 0 0
   /worldborder set 6000
   
   # 预生成（可选）
   /chunky world resource
   /chunky radius 3000
   /chunky start
   ```

**自动重置方案：**

可以使用以下插件实现自动重置：

1. **WorldReset**：专门用于定期重置世界的插件
2. **脚本方案**：使用定时任务配合服务器命令

**脚本示例（Linux）：**

创建重置脚本 `reset_resource.sh`：

```bash
#!/bin/bash
# 资源世界重置脚本

SERVER_DIR="/path/to/server"
WORLD_NAME="resource"

# 发送警告消息
screen -S minecraft -p 0 -X stuff "say 资源世界将在 5 分钟后重置，请尽快离开！$(printf '\r')"
sleep 300

# 传送所有玩家到主世界
screen -S minecraft -p 0 -X stuff "mv tp world @a$(printf '\r')"
sleep 5

# 卸载世界
screen -S minecraft -p 0 -X stuff "mv unload $WORLD_NAME$(printf '\r')"
sleep 5

# 删除世界文件夹
rm -rf "$SERVER_DIR/$WORLD_NAME"

# 重新创建世界
screen -S minecraft -p 0 -X stuff "mv create $WORLD_NAME NORMAL$(printf '\r')"
sleep 10

# 发送完成消息
screen -S minecraft -p 0 -X stuff "say 资源世界已重置完成！$(printf '\r')"
```

使用 cron 定时执行：
```bash
# 每周日凌晨 4 点重置
0 4 * * 0 /path/to/reset_resource.sh
```

## 自定义世界生成

### 超平坦世界配置

超平坦世界可以通过预设或自定义配置来生成。

**使用 Multiverse 创建超平坦世界：**

```bash
# 创建默认超平坦世界
/mv create flatworld NORMAL -t FLAT

# 使用自定义生成器字符串
/mv create flatworld NORMAL -t FLAT -g "minecraft:bedrock,2*minecraft:dirt,minecraft:grass_block;minecraft:plains"
```

**超平坦预设格式（1.13+）：**

格式：`方块层;生物群系;结构`

方块层格式：`数量*方块ID` 或 `方块ID`（从底部到顶部）

**常用预设：**

| 预设名称 | 配置 |
|---------|------|
| 经典平坦 | `minecraft:bedrock,2*minecraft:dirt,minecraft:grass_block` |
| 无底岩 | `3*minecraft:dirt,minecraft:grass_block` |
| 红石测试 | `minecraft:bedrock,3*minecraft:stone,52*minecraft:sandstone` |
| 虚空 | `minecraft:air` |
| 水世界 | `minecraft:bedrock,5*minecraft:stone,5*minecraft:water` |

**在 server.properties 中配置：**

```properties
level-type=FLAT
generator-settings={"layers":[{"block":"bedrock","height":1},{"block":"dirt","height":2},{"block":"grass_block","height":1}],"biome":"plains"}
```

### 自定义世界生成器

除了原版世界生成，还可以使用第三方世界生成器插件创建独特的地形。

**Terra**

Terra 是一个高度可配置的世界生成器，可以创建各种风格的地形。

- 官网：https://terra.polydev.org/
- 支持：Paper、Fabric、Forge 等

**使用 Terra 创建世界：**

```bash
# 安装 Terra 插件后
/mv create terraworld NORMAL -g Terra:OVERWORLD

# 使用其他 Terra 配置包
/mv create customworld NORMAL -g Terra:CONFIG_NAME
```

**其他世界生成器：**

| 生成器 | 说明 |
|-------|------|
| Terra | 高度可配置，支持自定义生物群系和结构 |
| Iris | 专注于美观地形，适合生存服务器 |
| Epic World Generator | 商业插件，提供精美的预设地形 |
| VoidGen | 生成虚空世界，适合空岛服务器 |

**使用自定义生成器的注意事项：**

1. **性能影响**：复杂的世界生成器可能影响区块生成速度
2. **兼容性**：确保生成器与服务端版本兼容
3. **配置学习**：大多数生成器需要学习其配置系统
4. **预生成推荐**：使用自定义生成器时更应该预生成世界

## 常见问题

### 世界文件损坏

**症状**：服务器启动时报错，或玩家进入特定区域时崩溃

**解决方案**：

1. **使用 NBT 编辑器修复**：
   - 使用 NBTExplorer 等工具检查 `level.dat`
   - 修复损坏的 NBT 数据

2. **删除损坏的区块**：
   - 使用 MCA Selector 等工具定位损坏区块
   - 删除损坏的 `.mca` 文件或特定区块
   - 服务器会重新生成这些区块

3. **从备份恢复**：
   - 如果有备份，直接恢复备份文件

### 世界加载缓慢

**可能原因**：
- 世界文件过大
- 磁盘 I/O 性能不足
- 内存不足

**解决方案**：
- 使用 SSD 存储世界文件
- 增加服务器内存
- 减少同时加载的世界数量
- 设置合理的视距（view-distance）

### 区块边界问题

**症状**：不同区块之间出现明显的地形断层

**原因**：
- 更换了世界种子
- 更换了世界生成器
- Minecraft 版本更新改变了世界生成算法

**解决方案**：
- 使用世界边界限制探索范围
- 预生成所有可访问区域
- 如果已经出现断层，可以使用 WorldEdit 等工具修复

### 玩家数据丢失

**预防措施**：
- 定期备份 `playerdata/` 文件夹
- 使用数据库存储重要数据（如经济、权限）
- 配置自动备份插件

**恢复方法**：
- 从备份中恢复对应玩家的 `.dat` 文件
- 文件名为玩家的 UUID

