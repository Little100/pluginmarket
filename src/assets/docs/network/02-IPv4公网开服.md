# IPv4 公网开服

本文介绍如何使用公网 IPv4 地址开设 Minecraft 服务器。

## 前提条件

- 已确认拥有公网 IPv4 地址，或运营商同意分配
- 了解基本的网络概念（参见 [概述与前置知识](01-概述与前置知识.md)）

---

## 第一步：申请公网 IPv4

如果你当前没有公网 IPv4，需要联系运营商申请。

### 各运营商申请难度

| 运营商 | 申请难度 | 说明 |
|--------|----------|------|
| 中国电信 | ⭐ 较容易 | 通常打客服电话即可申请，可能需要说明用途 |
| 中国联通 | ⭐⭐ 中等 | 部分地区可以申请，部分地区已无资源 |
| 中国移动 | ⭐⭐⭐ 较难 | 大部分地区无法申请，移动网络普遍使用 CGNAT |

### 申请话术建议

拨打运营商客服电话（电信 10000，联通 10010，移动 10086），可以这样说：

> "你好，我需要申请一个公网 IP 地址，用于远程办公/远程监控/NAS 访问。"

**注意事项**：
- 不要提及「开服务器」「游戏」等字眼，可能会被拒绝
- 如果客服说没有资源，可以尝试换个时间或换个客服再问
- 部分地区可能需要升级套餐或支付额外费用

---

## 第二步：光猫改桥接

大多数家庭网络的光猫默认工作在「路由模式」，这会导致多一层 NAT。将光猫改为「桥接模式」可以减少 NAT 层级，让路由器直接获取公网 IP。

### 什么情况需要改桥接

- 光猫是路由模式（光猫自带 WiFi 且能上网）
- 路由器 WAN 口获取的是内网 IP（如 `192.168.1.x`）

### 改桥接的方法

**方法一：联系运营商**

拨打客服电话，要求将光猫改为桥接模式。这是最简单的方法，运营商会远程操作。

**方法二：自行修改**

1. 获取光猫超级管理员密码（可在网上搜索你的光猫型号 + 超级密码）
2. 登录光猫管理页面（通常是 `192.168.1.1`）
3. 找到「网络设置」或「WAN 设置」
4. 将连接模式从「路由」改为「桥接」
5. 保存设置

**方法三：使用 DMZ**

如果无法改桥接，可以在光猫中设置 DMZ，将所有流量转发到路由器：

1. 登录光猫管理页面
2. 找到「DMZ 设置」或「DMZ 主机」
3. 将路由器的 IP 地址设为 DMZ 主机
4. 保存设置

### 改桥接后的配置

光猫改为桥接模式后，需要在路由器上配置 PPPoE 拨号：

1. 登录路由器管理页面
2. 在「WAN 设置」或「上网设置」中选择「PPPoE」
3. 输入宽带账号和密码（可以联系运营商获取）
4. 保存并重新连接

---

## 第三步：配置端口转发

端口转发（Port Forwarding）将外部对特定端口的访问转发到内网的服务器。

### Minecraft 需要的端口

| 版本 | 协议 | 端口 | 说明 |
|------|------|------|------|
| Java 版 | TCP | 25565 | 默认端口 |
| 基岩版 | UDP | 19132 | 默认端口 |
| Geyser | UDP | 19132 | 让基岩版玩家连接 Java 服务器 |

### 配置步骤

1. **固定服务器内网 IP**

   首先需要给运行服务器的电脑设置固定 IP，避免 IP 变化导致端口转发失效。

   **Windows**：
   1. 打开「设置」→「网络和 Internet」→「以太网」或「WLAN」
   2. 点击「编辑」IP 设置
   3. 选择「手动」，开启 IPv4
   4. 设置 IP 地址（如 `192.168.1.100`）、子网掩码（`255.255.255.0`）、网关（路由器 IP）

   **Linux**：
   
   编辑网络配置文件，以 Ubuntu/Debian 为例：

   ```bash
   sudo nano /etc/netplan/01-netcfg.yaml
   ```

   ```yaml
   network:
     version: 2
     ethernets:
       eth0:
         addresses:
           - 192.168.1.100/24
         gateway4: 192.168.1.1
         nameservers:
           addresses:
             - 223.5.5.5
             - 119.29.29.29
   ```

   ```bash
   sudo netplan apply
   ```

2. **在路由器中配置端口转发**

   不同品牌路由器的界面不同，但基本步骤相似：

   1. 登录路由器管理页面
   2. 找到「端口转发」「虚拟服务器」或「NAT 设置」
   3. 添加新规则：
      - 外部端口：`25565`
      - 内部端口：`25565`
      - 内部 IP：服务器的固定 IP（如 `192.168.1.100`）
      - 协议：TCP
   4. 如果需要支持基岩版，再添加一条 UDP 19132 的规则
   5. 保存设置

### 常见路由器配置位置

| 品牌 | 配置位置 |
|------|----------|
| TP-Link | 应用管理 → 虚拟服务器 |
| 小米/Redmi | 高级设置 → 端口转发 |
| 华硕 | 外部网络 → 虚拟服务器/端口转发 |
| 华为 | 更多功能 → 安全设置 → NAT 服务 |
| 网件 | 高级 → 高级设置 → 端口转发 |

---

## 第四步：配置防火墙

即使配置了端口转发，服务器本机的防火墙也可能阻止连接。

### Windows 防火墙

**方法一：通过图形界面**

1. 打开「Windows 安全中心」→「防火墙和网络保护」
2. 点击「高级设置」
3. 选择「入站规则」→「新建规则」
4. 选择「端口」→「下一步」
5. 选择「TCP」，输入端口 `25565`
6. 选择「允许连接」
7. 勾选所有配置文件（域、专用、公用）
8. 输入规则名称（如「Minecraft Server」）
9. 完成

如需支持基岩版，重复上述步骤，选择「UDP」和端口 `19132`。

**方法二：通过命令行**

以管理员身份运行 PowerShell：

```powershell
# 允许 Java 版 (TCP 25565)
New-NetFirewallRule -DisplayName "Minecraft Server TCP" -Direction Inbound -Protocol TCP -LocalPort 25565 -Action Allow

# 允许基岩版 (UDP 19132)
New-NetFirewallRule -DisplayName "Minecraft Server UDP" -Direction Inbound -Protocol UDP -LocalPort 19132 -Action Allow
```

### Linux 防火墙

**使用 firewalld（CentOS/RHEL/Fedora）**：

```bash
# 允许 Java 版
sudo firewall-cmd --permanent --add-port=25565/tcp

# 允许基岩版
sudo firewall-cmd --permanent --add-port=19132/udp

# 重新加载防火墙
sudo firewall-cmd --reload

# 查看已开放的端口
sudo firewall-cmd --list-ports
```

**使用 ufw（Ubuntu/Debian）**：

```bash
# 允许 Java 版
sudo ufw allow 25565/tcp

# 允许基岩版
sudo ufw allow 19132/udp

# 查看防火墙状态
sudo ufw status
```

**使用 iptables**：

```bash
# 允许 Java 版
sudo iptables -A INPUT -p tcp --dport 25565 -j ACCEPT

# 允许基岩版
sudo iptables -A INPUT -p udp --dport 19132 -j ACCEPT

# 保存规则（Debian/Ubuntu）
sudo iptables-save | sudo tee /etc/iptables/rules.v4

# 保存规则（CentOS/RHEL）
sudo service iptables save
```

---

## 第五步：配置 DDNS（动态域名）

家庭宽带的公网 IP 通常是动态的，每次重新拨号可能会变化。DDNS（动态域名解析）可以将一个固定的域名自动指向你变化的 IP。

### 常用 DDNS 服务

| 服务 | 免费额度 | 说明 |
|------|----------|------|
| 花生壳 | 1 个免费域名 | 国内服务，需要实名认证 |
| No-IP | 1 个免费域名 | 国外服务，每 30 天需要确认一次 |
| DuckDNS | 5 个免费域名 | 国外服务，完全免费 |
| Cloudflare | 无限制 | 需要自己有域名，通过 API 更新 |
| 阿里云 DDNS | 无限制 | 需要自己有域名，通过 API 更新 |

### 花生壳配置示例

1. 注册花生壳账号：https://hsk.oray.com
2. 完成实名认证
3. 获取免费域名或添加自己的域名
4. 下载并安装花生壳客户端
5. 登录客户端，域名会自动解析到当前 IP

### Cloudflare DDNS 配置示例

如果你有自己的域名并托管在 Cloudflare，可以使用脚本自动更新 DNS 记录。

**Linux 脚本**：

```bash
#!/bin/bash

# Cloudflare 配置
CF_API_TOKEN="your_api_token"
CF_ZONE_ID="your_zone_id"
CF_RECORD_NAME="mc.example.com"

# 获取当前公网 IP
CURRENT_IP=$(curl -s https://api.ipify.org)

# 获取 DNS 记录 ID
RECORD_ID=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/dns_records?name=${CF_RECORD_NAME}" \
  -H "Authorization: Bearer ${CF_API_TOKEN}" \
  -H "Content-Type: application/json" | jq -r '.result[0].id')

# 更新 DNS 记录
curl -s -X PUT "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/dns_records/${RECORD_ID}" \
  -H "Authorization: Bearer ${CF_API_TOKEN}" \
  -H "Content-Type: application/json" \
  --data "{\"type\":\"A\",\"name\":\"${CF_RECORD_NAME}\",\"content\":\"${CURRENT_IP}\",\"ttl\":60,\"proxied\":false}"
```

将此脚本添加到 crontab 定时执行：

```bash
# 每 5 分钟检查一次
*/5 * * * * /path/to/cloudflare-ddns.sh
```

---

## 验证配置

完成以上配置后，可以通过以下方式验证：

### 内网测试

在同一局域网内的其他设备上，使用服务器的内网 IP 连接：

```
192.168.1.100:25565
```

### 外网测试

1. 使用手机关闭 WiFi，使用移动数据
2. 使用你的公网 IP 或 DDNS 域名连接：
   ```
   your-domain.ddns.net:25565
   ```

### 在线端口检测

访问以下网站检测端口是否开放：
- https://www.yougetsignal.com/tools/open-ports/
- https://tool.chinaz.com/port

---

## 常见问题

### 端口转发配置正确但无法连接

1. 检查服务器防火墙是否放行
2. 检查服务器是否正在运行
3. 检查 `server.properties` 中的 `server-port` 是否正确
4. 尝试暂时关闭防火墙测试

### IP 地址经常变化

1. 配置 DDNS 服务
2. 联系运营商申请固定 IP（可能需要额外付费）

### 光猫无法改桥接

1. 使用 DMZ 功能
2. 直接在光猫上配置端口转发（如果光猫支持）

---

## 下一步

- 如果你的网络支持 IPv6，可以同时配置 [IPv6 公网开服](03-IPv6公网开服.md)
- 配置 [域名绑定](05-域名绑定与安全.md) 让玩家更容易记住服务器地址
