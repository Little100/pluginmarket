# IPv6 公网开服

本文介绍如何使用 IPv6 地址开设 Minecraft 服务器。

## IPv6 的优势

相比 IPv4，IPv6 开服具有以下优势：

| 特性 | 说明 |
|------|------|
| 地址充足 | 每个设备都可以获得公网 IPv6 地址 |
| 无需端口转发 | 设备直接暴露在公网，无需配置 NAT |
| 无需申请 | 大多数运营商默认分配 IPv6 |
| 配置简单 | 只需配置防火墙即可 |

---

## 前提条件

在开始之前，需要确认你的网络环境支持 IPv6。

### 确认 IPv6 可用

**方法一：访问测试网站**

访问以下网站测试 IPv6 连通性：
- https://test-ipv6.com
- https://ipv6-test.com

如果显示「你有 IPv6 地址」或评分为 10/10，说明 IPv6 可用。

**方法二：命令行测试**

**Windows**：

```cmd
ipconfig
```

查看是否有以 `2` 或 `3` 开头的 IPv6 地址（不是 `fe80::` 开头的链路本地地址）。

```cmd
ping -6 ipv6.google.com
```

**Linux**：

```bash
ip -6 addr show
```

查看是否有全局 IPv6 地址（scope global）。

```bash
ping6 ipv6.google.com
```

### 确认服务器有 IPv6 地址

**Windows**：

```cmd
ipconfig /all
```

查找类似以下格式的地址：
```
IPv6 地址: 240e:xxxx:xxxx:xxxx:xxxx:xxxx:xxxx:xxxx
```

**Linux**：

```bash
ip -6 addr show scope global
```

输出示例：
```
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP>
    inet6 240e:xxxx:xxxx:xxxx:xxxx:xxxx:xxxx:xxxx/64 scope global dynamic
```

---

## 配置 IPv6 防火墙

IPv6 没有 NAT，设备直接暴露在公网，因此防火墙配置尤为重要。

### Windows 防火墙

**方法一：图形界面**

1. 打开「Windows 安全中心」→「防火墙和网络保护」
2. 点击「高级设置」
3. 选择「入站规则」→「新建规则」
4. 选择「端口」→「下一步」
5. 选择「TCP」，输入端口 `25565`
6. 选择「允许连接」
7. 勾选所有配置文件
8. 输入规则名称（如「Minecraft Server IPv6」）

**方法二：命令行**

以管理员身份运行 PowerShell：

```powershell
# 允许 Java 版 (TCP 25565) - IPv6
New-NetFirewallRule -DisplayName "Minecraft Server TCP IPv6" -Direction Inbound -Protocol TCP -LocalPort 25565 -Action Allow -RemoteAddress Any

# 允许基岩版 (UDP 19132) - IPv6
New-NetFirewallRule -DisplayName "Minecraft Server UDP IPv6" -Direction Inbound -Protocol UDP -LocalPort 19132 -Action Allow -RemoteAddress Any
```

### Linux 防火墙

**使用 firewalld**：

```bash
# 允许 Java 版
sudo firewall-cmd --permanent --add-port=25565/tcp

# 允许基岩版
sudo firewall-cmd --permanent --add-port=19132/udp

# 重新加载
sudo firewall-cmd --reload
```

**使用 ufw**：

```bash
# 允许 Java 版
sudo ufw allow 25565/tcp

# 允许基岩版
sudo ufw allow 19132/udp
```

**使用 ip6tables**：

```bash
# 允许 Java 版
sudo ip6tables -A INPUT -p tcp --dport 25565 -j ACCEPT

# 允许基岩版
sudo ip6tables -A INPUT -p udp --dport 19132 -j ACCEPT

# 保存规则（Debian/Ubuntu）
sudo ip6tables-save | sudo tee /etc/iptables/rules.v6

# 保存规则（CentOS/RHEL）
sudo service ip6tables save
```

### 路由器 IPv6 防火墙

部分路由器默认会阻止 IPv6 入站连接，需要在路由器中放行。

1. 登录路由器管理页面
2. 找到「IPv6 防火墙」或「IPv6 安全设置」
3. 添加放行规则：
   - 协议：TCP
   - 端口：25565
   - 目标：服务器的 IPv6 地址
4. 如需支持基岩版，添加 UDP 19132 规则

---

## 获取服务器 IPv6 地址

玩家连接时需要使用服务器的 IPv6 地址。

### 查看 IPv6 地址

**Windows**：

```cmd
ipconfig | findstr "IPv6"
```

**Linux**：

```bash
ip -6 addr show scope global | grep inet6
```

### IPv6 地址格式

IPv6 地址较长，玩家输入时需要使用方括号包裹：

```
[240e:xxxx:xxxx:xxxx:xxxx:xxxx:xxxx:xxxx]:25565
```

如果使用默认端口 25565，可以省略端口号：

```
[240e:xxxx:xxxx:xxxx:xxxx:xxxx:xxxx:xxxx]
```

---

## IPv6 的局限性

### 部分玩家不支持 IPv6

并非所有玩家的网络都支持 IPv6，以下情况可能无法连接：

- 使用较老的路由器或光猫
- 运营商未开通 IPv6
- 使用某些移动网络
- 使用某些校园网或企业网

### 解决方案：IPv4 + IPv6 双栈

为了兼顾所有玩家，建议同时配置 IPv4 和 IPv6：

1. 如果有公网 IPv4，同时配置 [IPv4 公网开服](02-IPv4公网开服.md)
2. 如果没有公网 IPv4，可以使用内网穿透提供 IPv4 接入

### 域名配置

使用域名可以同时解析 IPv4 和 IPv6：

- A 记录：指向 IPv4 地址
- AAAA 记录：指向 IPv6 地址

客户端会自动选择可用的协议连接。详见 [域名绑定与安全](05-域名绑定与安全.md)。

---

## IPv6 DDNS

家庭宽带的 IPv6 地址也可能是动态的，可以配置 DDNS。

### Cloudflare IPv6 DDNS 脚本

```bash
#!/bin/bash

# Cloudflare 配置
CF_API_TOKEN="your_api_token"
CF_ZONE_ID="your_zone_id"
CF_RECORD_NAME="mc.example.com"

# 获取当前公网 IPv6
CURRENT_IP=$(curl -s -6 https://api6.ipify.org)

# 获取 DNS 记录 ID
RECORD_ID=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/dns_records?name=${CF_RECORD_NAME}&type=AAAA" \
  -H "Authorization: Bearer ${CF_API_TOKEN}" \
  -H "Content-Type: application/json" | jq -r '.result[0].id')

# 更新 AAAA 记录
curl -s -X PUT "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/dns_records/${RECORD_ID}" \
  -H "Authorization: Bearer ${CF_API_TOKEN}" \
  -H "Content-Type: application/json" \
  --data "{\"type\":\"AAAA\",\"name\":\"${CF_RECORD_NAME}\",\"content\":\"${CURRENT_IP}\",\"ttl\":60,\"proxied\":false}"
```

---

## 验证配置

### 内网测试

在同一网络内使用 IPv6 地址连接：

```
[服务器IPv6地址]:25565
```

### 外网测试

1. 让有 IPv6 的朋友帮忙测试
2. 使用支持 IPv6 的手机移动网络测试
3. 使用在线 IPv6 端口检测工具：
   - https://ipv6.chappell-family.com/ipv6tcptest/

---

## 常见问题

### 没有 IPv6 地址

1. 检查路由器是否开启 IPv6
2. 检查光猫是否支持 IPv6
3. 联系运营商确认是否开通 IPv6

### 有 IPv6 地址但无法连接

1. 检查防火墙是否放行
2. 检查路由器 IPv6 防火墙
3. 确认玩家网络支持 IPv6

### IPv6 地址经常变化

1. 配置 IPv6 DDNS
2. 部分路由器支持 IPv6 前缀委派（PD），可以获得相对稳定的地址

---

## 下一步

- 如果需要兼容不支持 IPv6 的玩家，参考 [IPv4 公网开服](02-IPv4公网开服.md) 或内网穿透方案
- 配置 [域名绑定](05-域名绑定与安全.md) 简化连接地址
