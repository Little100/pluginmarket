# Minecraft 服务器备份与恢复指南

## 一、备份的重要性

### 为什么需要备份

服务器数据是运营过程中最宝贵的资产。玩家投入大量时间建造的建筑、收集的物品、完成的任务进度，一旦丢失将无法挽回。定期备份是保护这些数据的唯一可靠方式。

### 常见的数据丢失场景

1. **硬件故障**：硬盘损坏、服务器宕机
2. **软件问题**：插件冲突导致数据损坏、服务端崩溃
3. **人为失误**：误删文件、错误的配置修改
4. **恶意破坏**：黑客入侵、恶意玩家使用漏洞
5. **自然灾害**：机房断电、火灾等不可抗力
6. **版本升级失败**：更新服务端或插件后出现兼容性问题

---

## 二、需要备份的内容

### 2.1 世界存档

世界存档是最重要的备份内容，包含所有地形、建筑和实体数据。

| 目录名 | 说明 |
|--------|------|
| `world/` | 主世界存档 |
| `world_nether/` | 下界存档 |
| `world_the_end/` | 末地存档 |

> **注意**：如果使用了多世界插件（如 Multiverse），还需要备份额外创建的世界目录。

### 2.2 插件数据

`plugins/` 目录包含所有插件及其数据：

```
plugins/
├── PluginName/           # 插件配置和数据目录
│   ├── config.yml        # 插件配置文件
│   └── data/             # 插件数据文件
├── PluginName.jar        # 插件本体
└── ...
```

重要的插件数据包括：
- 经济插件的玩家余额数据
- 权限插件的权限配置
- 领地插件的领地数据
- 商店插件的商品和交易记录

### 2.3 配置文件

服务器核心配置文件：

| 文件名 | 说明 |
|--------|------|
| `server.properties` | 服务器基础配置 |
| `bukkit.yml` | Bukkit 配置 |
| `spigot.yml` | Spigot 配置 |
| `paper.yml` 或 `config/paper-global.yml` | Paper 配置 |
| `purpur.yml` | Purpur 配置（如使用） |
| `ops.json` | 管理员列表 |
| `whitelist.json` | 白名单 |
| `banned-players.json` | 封禁玩家列表 |
| `banned-ips.json` | 封禁 IP 列表 |

### 2.4 模组数据（模组服）

如果运行的是模组服务器：

| 目录/文件 | 说明 |
|-----------|------|
| `mods/` | 模组文件目录 |
| `config/` | 模组配置目录 |
| `defaultconfigs/` | 默认配置（Forge） |

### 2.5 玩家数据

玩家数据通常存储在以下位置：

```
world/playerdata/          # 玩家背包、位置等数据
world/advancements/        # 玩家成就进度
world/stats/               # 玩家统计数据
```

---

## 三、手动备份

### 3.1 Linux 下使用命令行备份

#### 使用 tar 命令

```bash
# 创建 tar.gz 压缩备份
tar -czvf backup_$(date +%Y%m%d_%H%M%S).tar.gz \
    world/ world_nether/ world_the_end/ \
    plugins/ \
    server.properties bukkit.yml spigot.yml

# 仅备份世界存档
tar -czvf world_backup_$(date +%Y%m%d).tar.gz world/ world_nether/ world_the_end/
```

#### 使用 zip 命令

```bash
# 创建 zip 压缩备份
zip -r backup_$(date +%Y%m%d_%H%M%S).zip \
    world/ world_nether/ world_the_end/ \
    plugins/ \
    server.properties bukkit.yml spigot.yml
```

#### 排除不需要的文件

```bash
# 排除日志和临时文件
tar -czvf backup.tar.gz \
    --exclude='*.log' \
    --exclude='logs/' \
    --exclude='cache/' \
    world/ plugins/
```

### 3.2 Windows 下备份

#### 使用压缩软件

1. 打开文件资源管理器，进入服务器目录
2. 选中需要备份的文件夹和文件
3. 右键选择"发送到" → "压缩(zipped)文件夹"
4. 或使用 7-Zip、WinRAR 等工具创建压缩包

#### 使用命令行（PowerShell）

```powershell
# 创建 zip 备份
$date = Get-Date -Format "yyyyMMdd_HHmmss"
Compress-Archive -Path world, world_nether, world_the_end, plugins, server.properties -DestinationPath "backup_$date.zip"
```

### 3.3 热备份与冷备份

#### 冷备份（推荐）

关闭服务器后进行备份，确保数据完整性。

```bash
# 1. 关闭服务器
screen -S minecraft -X stuff "stop$(printf '\r')"

# 2. 等待服务器完全关闭
sleep 30

# 3. 执行备份
tar -czvf backup_$(date +%Y%m%d).tar.gz world/ plugins/

# 4. 重新启动服务器
screen -S minecraft -X stuff "./start.sh$(printf '\r')"
```

#### 热备份

在服务器运行时备份，需要先保存世界数据并禁用自动保存。

```bash
# 通过 RCON 或控制台执行
save-all          # 保存所有数据
save-off          # 关闭自动保存

# 执行备份操作
tar -czvf backup.tar.gz world/ plugins/

# 备份完成后恢复自动保存
save-on
```

> **警告**：热备份存在数据不一致的风险，重要数据建议使用冷备份。

---

## 四、自动备份方案

### 4.1 Linux cron 定时备份

#### 创建备份脚本

创建 `/home/minecraft/backup.sh`：

```bash
#!/bin/bash

# 配置变量
SERVER_DIR="/home/minecraft/server"
BACKUP_DIR="/home/minecraft/backups"
SCREEN_NAME="minecraft"
MAX_BACKUPS=7
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p "$BACKUP_DIR"

# 进入服务器目录
cd "$SERVER_DIR"

# 通知玩家
screen -S "$SCREEN_NAME" -X stuff "say 服务器即将进行自动备份...$(printf '\r')"

# 保存世界数据
screen -S "$SCREEN_NAME" -X stuff "save-all$(printf '\r')"
sleep 5
screen -S "$SCREEN_NAME" -X stuff "save-off$(printf '\r')"
sleep 2

# 执行备份
tar -czf "$BACKUP_DIR/backup_$DATE.tar.gz" \
    world/ world_nether/ world_the_end/ \
    plugins/ \
    server.properties bukkit.yml spigot.yml paper.yml 2>/dev/null

# 恢复自动保存
screen -S "$SCREEN_NAME" -X stuff "save-on$(printf '\r')"

# 通知玩家备份完成
screen -S "$SCREEN_NAME" -X stuff "say 备份完成！$(printf '\r')"

# 删除旧备份，保留最近 N 份
cd "$BACKUP_DIR"
ls -t backup_*.tar.gz | tail -n +$((MAX_BACKUPS + 1)) | xargs -r rm -f

echo "备份完成: backup_$DATE.tar.gz"
```

#### 设置执行权限

```bash
chmod +x /home/minecraft/backup.sh
```

#### 配置 cron 定时任务

```bash
# 编辑 crontab
crontab -e

# 添加定时任务（每天凌晨 4 点执行）
0 4 * * * /home/minecraft/backup.sh >> /home/minecraft/backup.log 2>&1

# 每 6 小时执行一次
0 */6 * * * /home/minecraft/backup.sh >> /home/minecraft/backup.log 2>&1
```

### 4.2 Windows 任务计划程序

#### 创建备份脚本

创建 `C:\MinecraftServer\backup.bat`：

```batch
@echo off
setlocal enabledelayedexpansion

:: 配置变量
set SERVER_DIR=C:\MinecraftServer
set BACKUP_DIR=C:\MinecraftBackups
set MAX_BACKUPS=7

:: 获取当前日期时间
for /f "tokens=2 delims==" %%I in ('wmic os get localdatetime /value') do set datetime=%%I
set DATE=%datetime:~0,8%_%datetime:~8,6%

:: 创建备份目录
if not exist "%BACKUP_DIR%" mkdir "%BACKUP_DIR%"

:: 进入服务器目录
cd /d "%SERVER_DIR%"

:: 使用 7-Zip 创建备份（需要安装 7-Zip）
"C:\Program Files\7-Zip\7z.exe" a -tzip "%BACKUP_DIR%\backup_%DATE%.zip" ^
    world\ world_nether\ world_the_end\ ^
    plugins\ ^
    server.properties bukkit.yml spigot.yml

:: 删除旧备份
cd /d "%BACKUP_DIR%"
for /f "skip=%MAX_BACKUPS% delims=" %%F in ('dir /b /o-d backup_*.zip 2^>nul') do del "%%F"

echo 备份完成: backup_%DATE%.zip
```

#### 使用 PowerShell 脚本

创建 `C:\MinecraftServer\backup.ps1`：

```powershell
# 配置变量
$ServerDir = "C:\MinecraftServer"
$BackupDir = "C:\MinecraftBackups"
$MaxBackups = 7
$Date = Get-Date -Format "yyyyMMdd_HHmmss"

# 创建备份目录
if (!(Test-Path $BackupDir)) {
    New-Item -ItemType Directory -Path $BackupDir
}

# 进入服务器目录
Set-Location $ServerDir

# 创建备份
$BackupFile = "$BackupDir\backup_$Date.zip"
$ItemsToBackup = @(
    "world",
    "world_nether", 
    "world_the_end",
    "plugins",
    "server.properties",
    "bukkit.yml",
    "spigot.yml"
)

Compress-Archive -Path $ItemsToBackup -DestinationPath $BackupFile -CompressionLevel Optimal

# 删除旧备份
Get-ChildItem -Path $BackupDir -Filter "backup_*.zip" | 
    Sort-Object LastWriteTime -Descending | 
    Select-Object -Skip $MaxBackups | 
    Remove-Item -Force

Write-Host "备份完成: $BackupFile"
```

#### 配置任务计划程序

1. 打开"任务计划程序"（Win + R，输入 `taskschd.msc`）
2. 点击"创建基本任务"
3. 设置名称为"Minecraft 服务器备份"
4. 选择触发器（如"每天"）
5. 设置执行时间（建议凌晨低峰期）
6. 选择"启动程序"
7. 程序路径填写 `powershell.exe`
8. 参数填写 `-ExecutionPolicy Bypass -File "C:\MinecraftServer\backup.ps1"`
9. 完成创建

### 4.3 备份轮转策略

#### 保留策略示例

```bash
# 保留策略：
# - 每日备份保留 7 天
# - 每周备份保留 4 周
# - 每月备份保留 12 个月

#!/bin/bash
BACKUP_DIR="/home/minecraft/backups"
DATE=$(date +%Y%m%d)
DAY_OF_WEEK=$(date +%u)
DAY_OF_MONTH=$(date +%d)

# 创建每日备份
tar -czf "$BACKUP_DIR/daily/backup_$DATE.tar.gz" world/ plugins/

# 如果是周日，创建周备份
if [ "$DAY_OF_WEEK" -eq 7 ]; then
    cp "$BACKUP_DIR/daily/backup_$DATE.tar.gz" "$BACKUP_DIR/weekly/"
fi

# 如果是每月 1 号，创建月备份
if [ "$DAY_OF_MONTH" -eq "01" ]; then
    cp "$BACKUP_DIR/daily/backup_$DATE.tar.gz" "$BACKUP_DIR/monthly/"
fi

# 清理旧备份
find "$BACKUP_DIR/daily" -name "*.tar.gz" -mtime +7 -delete
find "$BACKUP_DIR/weekly" -name "*.tar.gz" -mtime +28 -delete
find "$BACKUP_DIR/monthly" -name "*.tar.gz" -mtime +365 -delete
```

---

## 五、备份插件

### 5.1 DriveBackupV2

功能强大的备份插件，支持上传到多种云存储服务。

**支持的存储服务**：
- Google Drive
- OneDrive
- Dropbox
- FTP/SFTP 服务器
- 本地存储

**安装与配置**：

1. 下载插件：https://www.spigotmc.org/resources/drivebackupv2.79519/
2. 放入 `plugins/` 目录
3. 重启服务器
4. 编辑 `plugins/DriveBackupV2/config.yml`

**基础配置示例**：

```yaml
# config.yml
backups:
  backup-list:
    - path: "world"
      format: "ZIP"
    - path: "world_nether"
      format: "ZIP"
    - path: "world_the_end"
      format: "ZIP"
    - path: "plugins"
      format: "ZIP"

  schedule:
    backup-schedule-list:
      - "00:00"
      - "06:00"
      - "12:00"
      - "18:00"

  backup-thread-priority: 1
  keep-count: 7

googledrive:
  enabled: true
```

### 5.2 eBackup

轻量级备份插件，配置简单。

**下载地址**：https://www.spigotmc.org/resources/ebackup.69917/

**基础配置**：

```yaml
# config.yml
backup-format: "yyyy-MM-dd HH-mm-ss"
backups-folder-name: "backups"
max-backups: 7

backup-files:
  - "world"
  - "world_nether"
  - "world_the_end"
  - "plugins"

schedule:
  enabled: true
  interval: 360  # 分钟
```

### 5.3 ServerBackup

功能全面的备份插件。

**下载地址**：https://www.spigotmc.org/resources/server-backup.79320/

---

## 六、异地备份

### 6.1 使用 rsync 同步到远程服务器

rsync 是 Linux 下高效的文件同步工具，支持增量传输。

```bash
# 基础同步命令
rsync -avz --progress /home/minecraft/backups/ user@remote:/backups/minecraft/

# 使用 SSH 密钥认证（推荐）
rsync -avz -e "ssh -i ~/.ssh/backup_key" /home/minecraft/backups/ user@remote:/backups/

# 删除远程多余文件（镜像同步）
rsync -avz --delete /home/minecraft/backups/ user@remote:/backups/minecraft/
```

#### 配置 SSH 免密登录

```bash
# 生成 SSH 密钥
ssh-keygen -t rsa -b 4096 -f ~/.ssh/backup_key -N ""

# 复制公钥到远程服务器
ssh-copy-id -i ~/.ssh/backup_key.pub user@remote-server
```

### 6.2 使用 rclone 上传到对象存储

rclone 支持多种云存储服务，包括阿里云 OSS、腾讯云 COS、AWS S3 等。

#### 安装 rclone

```bash
# Linux
curl https://rclone.org/install.sh | sudo bash

# 或使用包管理器
sudo apt install rclone
```

#### 配置阿里云 OSS

```bash
rclone config

# 按提示操作：
# n) New remote
# name> aliyun-oss
# Storage> s3
# provider> Alibaba
# access_key_id> 你的 AccessKey ID
# secret_access_key> 你的 AccessKey Secret
# endpoint> oss-cn-hangzhou.aliyuncs.com
```

#### 上传备份

```bash
# 上传单个文件
rclone copy /home/minecraft/backups/backup_20240101.tar.gz aliyun-oss:bucket-name/minecraft/

# 同步整个备份目录
rclone sync /home/minecraft/backups/ aliyun-oss:bucket-name/minecraft/backups/

# 删除超过 7 天的旧备份
rclone delete --min-age 7d aliyun-oss:bucket-name/minecraft/backups/
```

#### 配置腾讯云 COS

```bash
rclone config

# provider> TencentCOS
# access_key_id> 你的 SecretId
# secret_access_key> 你的 SecretKey
# endpoint> cos.ap-guangzhou.myqcloud.com
```

### 6.3 云盘同步

对于 Windows 服务器，可以使用云盘客户端自动同步备份目录：

1. 安装云盘客户端（OneDrive、坚果云、百度网盘等）
2. 将备份目录设置为同步目录
3. 云盘会自动上传新的备份文件

---

## 七、恢复操作

### 7.1 从备份恢复世界存档

#### Linux 恢复步骤

```bash
# 1. 停止服务器
screen -S minecraft -X stuff "stop$(printf '\r')"
sleep 30

# 2. 备份当前数据（以防万一）
mv world world_old
mv world_nether world_nether_old
mv world_the_end world_the_end_old

# 3. 解压备份文件
tar -xzvf backup_20240101.tar.gz

# 4. 启动服务器
./start.sh
```

#### Windows 恢复步骤

1. 关闭服务器
2. 将当前的 `world`、`world_nether`、`world_the_end` 文件夹重命名（如添加 `_old` 后缀）
3. 解压备份文件，将世界文件夹复制到服务器目录
4. 启动服务器

### 7.2 从备份恢复插件配置

```bash
# 恢复单个插件配置
tar -xzvf backup.tar.gz plugins/PluginName/

# 恢复所有插件
tar -xzvf backup.tar.gz plugins/
```

> **注意**：恢复插件配置后，部分插件可能需要重载或重启服务器才能生效。

### 7.3 恢复注意事项

#### 版本兼容性

- 确保备份时的服务端版本与当前版本兼容
- 高版本存档通常无法在低版本服务端运行
- 恢复前检查插件版本是否匹配

#### 权限问题（Linux）

```bash
# 恢复后修复文件权限
chown -R minecraft:minecraft /home/minecraft/server/
chmod -R 755 /home/minecraft/server/
```

#### 数据一致性

- 恢复世界存档时，建议同时恢复相关的插件数据
- 避免世界数据与插件数据版本不一致

---

## 八、最佳实践

### 8.1 备份频率建议

| 服务器类型 | 建议频率 | 说明 |
|------------|----------|------|
| 小型私服（< 10 人） | 每天 1 次 | 低活跃度，每日备份足够 |
| 中型服务器（10-50 人） | 每 6-12 小时 | 中等活跃度 |
| 大型服务器（> 50 人） | 每 2-4 小时 | 高活跃度，数据变化频繁 |
| 活动期间 | 每 1-2 小时 | 重要活动期间增加频率 |

### 8.2 3-2-1 备份原则

这是业界公认的数据保护最佳实践：

- **3** 份数据副本：原始数据 + 2 份备份
- **2** 种存储介质：如本地硬盘 + 云存储
- **1** 份异地备份：存放在不同物理位置

#### 实施示例

```
原始数据：服务器本地 /home/minecraft/server/
本地备份：服务器本地 /home/minecraft/backups/
异地备份：阿里云 OSS 或远程服务器
```

### 8.3 备份检查清单

定期验证备份的有效性：

- [ ] 备份文件是否完整（检查文件大小）
- [ ] 备份文件是否可以正常解压
- [ ] 定期进行恢复测试
- [ ] 检查异地备份是否同步成功
- [ ] 监控备份脚本的执行日志

### 8.4 备份命名规范

建议使用统一的命名格式便于管理：

```
backup_YYYYMMDD_HHMMSS.tar.gz
backup_full_20240101_040000.tar.gz    # 完整备份
backup_world_20240101_040000.tar.gz   # 仅世界存档
backup_plugins_20240101_040000.tar.gz # 仅插件数据
```

---

## 总结

数据备份是服务器运维中最重要的工作之一。建议：

1. 制定适合自己服务器的备份策略
2. 配置自动备份，避免依赖人工操作
3. 遵循 3-2-1 原则，确保数据安全
4. 定期验证备份的有效性
5. 记录备份和恢复流程，便于紧急情况下快速响应
