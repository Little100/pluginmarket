# Minecraft 服务器安全防护指南

## 概述

Minecraft 服务器作为一个对外开放的网络服务，面临着多种安全威胁。了解这些威胁并采取相应的防护措施，是保障服务器稳定运行的关键。

### 常见安全威胁类型

1. **未授权访问**：未经许可的玩家进入服务器，可能进行破坏或盗取资源
2. **DDoS 攻击**：分布式拒绝服务攻击，通过大量请求使服务器无法正常响应
3. **机器人攻击**：使用自动化程序批量创建假玩家，消耗服务器资源
4. **漏洞利用**：利用游戏或插件的漏洞进行崩服、刷物品等恶意行为
5. **社会工程学攻击**：通过欺骗手段获取管理员权限或敏感信息
6. **内部威胁**：拥有权限的管理员或玩家滥用权限

---

## 白名单管理

白名单是最基础的访问控制机制，只允许名单中的玩家进入服务器。

### server.properties 配置

在 `server.properties` 文件中设置：

```properties
# 启用白名单
white-list=true

# 强制执行白名单（即使玩家已在线，移出白名单后也会被踢出）
enforce-whitelist=true
```

### 白名单命令

| 命令 | 功能 | 权限要求 |
|------|------|----------|
| `/whitelist on` | 启用白名单 | OP |
| `/whitelist off` | 关闭白名单 | OP |
| `/whitelist add <玩家名>` | 添加玩家到白名单 | OP |
| `/whitelist remove <玩家名>` | 从白名单移除玩家 | OP |
| `/whitelist list` | 查看白名单列表 | OP |
| `/whitelist reload` | 重新加载白名单文件 | OP |

### 白名单文件

白名单数据存储在服务器根目录的 `whitelist.json` 文件中：

```json
[
  {
    "uuid": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
    "name": "PlayerName"
  }
]
```

### 离线模式注意事项

在离线模式（`online-mode=false`）下使用白名单需要注意：

1. **UUID 不固定**：离线模式下玩家的 UUID 基于用户名生成，更改用户名会导致 UUID 变化
2. **用户名可伪造**：任何人都可以使用白名单中的用户名进入服务器
3. **建议配合登录插件**：使用 AuthMe 等插件进行二次验证

---

## 正版验证

### online-mode 设置

`server.properties` 中的 `online-mode` 选项决定服务器是否验证玩家的正版身份：

```properties
# 启用正版验证
online-mode=true
```

### 正版验证的意义

- **身份唯一性**：每个正版账号都有唯一的 UUID，无法伪造
- **防止冒充**：其他人无法使用你的用户名进入服务器
- **官方支持**：可以使用 Mojang 的皮肤系统和其他官方服务

### 离线模式的风险

将 `online-mode` 设置为 `false` 会带来以下风险：

1. **身份伪造**：任何人可以使用任意用户名进入服务器
2. **OP 权限盗用**：攻击者可以使用管理员的用户名获取 OP 权限
3. **数据混乱**：同一用户名可能对应不同的实际玩家
4. **无法使用正版皮肤**：玩家皮肤无法正常显示

### 使用登录插件保护离线服务器

如果必须使用离线模式（例如允许非正版玩家），应当安装登录插件：

#### AuthMe Reloaded

AuthMe 是最流行的登录验证插件，提供注册和登录功能。

**基本配置**（`plugins/AuthMe/config.yml`）：

```yaml
settings:
  # 注册设置
  registration:
    enabled: true
    # 强制注册
    force: true
  
  # 登录设置
  security:
    # 密码最小长度
    minPasswordLength: 6
    # 密码最大长度
    maxPasswordLength: 30
    # 登录超时时间（秒）
    timeout: 60
    # 最大登录尝试次数
    maxLoginTry: 5
    # 登录失败后的冷却时间（秒）
    tempbanLength: 480

  # 会话设置
  sessions:
    enabled: true
    # 会话有效期（分钟）
    timeout: 10

  # 限制设置
  restrictions:
    # 未登录时禁止移动
    allowMovement: false
    # 未登录时禁止交互
    allowedCommands:
      - /login
      - /register
      - /l
      - /reg
```

**常用命令**：

| 命令 | 功能 |
|------|------|
| `/register <密码> <确认密码>` | 注册账号 |
| `/login <密码>` | 登录账号 |
| `/changepassword <旧密码> <新密码>` | 修改密码 |
| `/authme register <玩家> <密码>` | 管理员为玩家注册 |
| `/authme unregister <玩家>` | 删除玩家注册信息 |

#### 其他登录插件

- **nLogin**：高性能登录插件，支持多服务器同步
- **LockLogin**：功能丰富，支持 2FA 双因素认证
- **JPremium / FastLogin**：自动检测正版玩家，免登录

---

## 防火墙配置

防火墙是服务器的第一道防线，用于控制网络流量的进出。

### Linux iptables 配置

#### 基本规则

```bash
# 清空现有规则
iptables -F
iptables -X

# 设置默认策略
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# 允许本地回环
iptables -A INPUT -i lo -j ACCEPT

# 允许已建立的连接
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# 允许 SSH（根据实际端口修改）
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# 允许 Minecraft 端口
iptables -A INPUT -p tcp --dport 25565 -j ACCEPT

# 保存规则
iptables-save > /etc/iptables/rules.v4
```

#### 限制连接速率

```bash
# 限制每个 IP 的新连接速率（防止简单的连接洪水）
iptables -A INPUT -p tcp --dport 25565 -m state --state NEW -m recent --set
iptables -A INPUT -p tcp --dport 25565 -m state --state NEW -m recent --update --seconds 60 --hitcount 10 -j DROP
```

### Linux ufw 配置

ufw（Uncomplicated Firewall）是 iptables 的简化前端：

```bash
# 启用 ufw
sudo ufw enable

# 设置默认策略
sudo ufw default deny incoming
sudo ufw default allow outgoing

# 允许 SSH
sudo ufw allow 22/tcp

# 允许 Minecraft 端口
sudo ufw allow 25565/tcp

# 查看状态
sudo ufw status verbose
```

### 端口管理建议

| 端口 | 服务 | 建议 |
|------|------|------|
| 25565 | Minecraft 游戏端口 | 对外开放 |
| 25575 | RCON 远程控制 | 仅限特定 IP 或关闭 |
| 8123 | Dynmap 地图 | 按需开放 |
| 8192 | Plan 统计面板 | 按需开放 |
| 3306 | MySQL 数据库 | 仅限本地或内网 |

### 限制 RCON 访问

RCON（Remote Console）允许远程执行服务器命令，必须严格限制：

**server.properties 配置**：

```properties
# 启用 RCON
enable-rcon=true
# RCON 端口
rcon.port=25575
# RCON 密码（使用强密码）
rcon.password=YourStrongPassword123!
```

**防火墙限制**：

```bash
# 只允许特定 IP 访问 RCON
iptables -A INPUT -p tcp --dport 25575 -s 192.168.1.100 -j ACCEPT
iptables -A INPUT -p tcp --dport 25575 -j DROP
```

**最佳实践**：

1. 如果不需要 RCON，直接关闭（`enable-rcon=false`）
2. 使用强密码，至少 16 位，包含大小写字母、数字和特殊字符
3. 限制可访问的 IP 地址
4. 定期更换密码

---

## DDoS 防护

### 什么是 DDoS 攻击

DDoS（Distributed Denial of Service，分布式拒绝服务）攻击是指攻击者利用大量受控设备（僵尸网络）同时向目标服务器发送请求，导致服务器资源耗尽，无法响应正常用户的请求。

**常见的 DDoS 攻击类型**：

1. **流量型攻击**：发送大量数据包占满带宽
2. **协议型攻击**：利用协议漏洞消耗服务器资源（如 SYN Flood）
3. **应用层攻击**：模拟正常请求消耗应用资源

### 使用代理防护服务

#### TCPShield

TCPShield 是专为 Minecraft 设计的 DDoS 防护服务：

**配置步骤**：

1. 注册 TCPShield 账号并添加服务器
2. 获取分配的域名（如 `yourserver.tcpshield.com`）
3. 在服务器安装 TCPShield 插件
4. 配置防火墙只允许 TCPShield 的 IP 访问

**防火墙配置**：

```bash
# 只允许 TCPShield IP 段访问 Minecraft 端口
# 具体 IP 段请参考 TCPShield 官方文档
iptables -A INPUT -p tcp --dport 25565 -s 185.219.0.0/16 -j ACCEPT
iptables -A INPUT -p tcp --dport 25565 -j DROP
```

#### Cosmic Guard

Cosmic Guard 是另一个流行的 Minecraft DDoS 防护服务，提供类似的功能。

### 云服务商 DDoS 防护

主流云服务商都提供 DDoS 防护服务：

| 服务商 | 防护服务 | 特点 |
|--------|----------|------|
| 阿里云 | DDoS 高防 | 支持 TCP 协议，可防护游戏服务器 |
| 腾讯云 | DDoS 高防包 | 提供弹性防护，按需付费 |
| AWS | Shield | 标准版免费，高级版提供更强防护 |
| Cloudflare | Spectrum | 支持 TCP/UDP 代理 |

### Proxy Protocol 配置

当使用代理服务时，需要配置 Proxy Protocol 以获取玩家真实 IP。

#### Velocity 配置

在 `velocity.toml` 中：

```toml
[advanced]
# 启用 Proxy Protocol
proxy-protocol = true
```

#### BungeeCord 配置

在 `config.yml` 中：

```yaml
listeners:
  - host: 0.0.0.0:25565
    # 启用 Proxy Protocol
    proxy_protocol: true
```

**注意**：启用 Proxy Protocol 后，必须通过支持该协议的代理访问服务器，直接连接将无法正常工作。

---

## 反机器人/反假人

机器人攻击（Bot Attack）是指使用自动化程序批量创建假玩家连接服务器，消耗服务器资源或进行恶意行为。

### BotSentry

BotSentry 是一款高效的反机器人插件：

**主要功能**：

- 验证码验证
- 连接频率限制
- 地理位置过滤
- VPN/代理检测

**基本配置**（`plugins/BotSentry/config.yml`）：

```yaml
# 验证模式
verification:
  # 启用验证
  enabled: true
  # 验证类型：CAPTCHA（验证码）、MOVEMENT（移动验证）
  type: CAPTCHA

# 连接限制
connection:
  # 每秒最大连接数
  maxConnectionsPerSecond: 3
  # 连接冷却时间（毫秒）
  connectionCooldown: 1000
```

### AntiBot

AntiBot 是另一款流行的反机器人插件：

**主要功能**：

- 连接速率限制
- 首次加入验证
- 国家/地区过滤
- 自定义验证规则

**基本配置**（`plugins/AntiBot/config.yml`）：

```yaml
# 启用插件
enabled: true

# 连接限制
connection-limit:
  # 启用连接限制
  enabled: true
  # 时间窗口内最大连接数
  max-connections: 5
  # 时间窗口（秒）
  time-window: 10

# 首次加入检查
first-join-check:
  enabled: true
  # 检查类型
  check-type: CAPTCHA
```

### Velocity 内置连接限制

Velocity 代理服务器内置了连接限制功能：

**velocity.toml 配置**：

```toml
[advanced]
# 连接超时时间（毫秒）
connection-timeout = 5000
# 读取超时时间（毫秒）
read-timeout = 30000
# 登录速率限制（每秒允许的登录次数）
login-ratelimit = 3000
```

---

## 服务器加固

### 禁用危险命令

通过权限插件限制危险命令的使用：

**LuckPerms 配置示例**：

```bash
# 移除默认组的危险命令权限
/lp group default permission set minecraft.command.op false
/lp group default permission set minecraft.command.deop false
/lp group default permission set minecraft.command.stop false
/lp group default permission set minecraft.command.ban false
/lp group default permission set minecraft.command.pardon false
```

### 限制 OP 权限

**server.properties 配置**：

```properties
# OP 权限等级（1-4）
# 1: 可以绕过出生点保护
# 2: 可以使用单人游戏作弊命令和命令方块
# 3: 可以使用多人游戏管理命令
# 4: 可以使用所有命令
op-permission-level=3
```

**最佳实践**：

1. 尽量减少 OP 数量
2. 使用权限插件代替 OP 进行权限管理
3. 定期审查 OP 列表
4. 为不同管理员分配不同权限等级

### 关闭命令方块

命令方块可以执行任意命令，存在安全风险：

```properties
# 禁用命令方块
enable-command-block=false
```

如果必须使用命令方块，应当：

1. 限制命令方块的放置权限
2. 定期检查已放置的命令方块
3. 使用 WorldGuard 等插件限制命令方块的使用区域

### 关闭或限制远程控制台

**RCON 安全配置**：

```properties
# 如果不需要，直接关闭
enable-rcon=false

# 如果需要使用，确保：
# 1. 使用强密码
rcon.password=VeryStr0ng&C0mplexP@ssw0rd!
# 2. 更改默认端口
rcon.port=38291
# 3. 配合防火墙限制访问 IP
```

### Linux 文件权限设置

正确的文件权限可以防止未授权访问：

```bash
# 设置服务器目录所有者
sudo chown -R minecraft:minecraft /opt/minecraft

# 设置目录权限（所有者可读写执行，组可读执行，其他无权限）
sudo chmod 750 /opt/minecraft

# 设置文件权限（所有者可读写，组可读，其他无权限）
sudo chmod 640 /opt/minecraft/*.properties
sudo chmod 640 /opt/minecraft/*.json

# 设置敏感文件权限（仅所有者可读写）
sudo chmod 600 /opt/minecraft/ops.json
sudo chmod 600 /opt/minecraft/whitelist.json
```

**权限数字说明**：

| 数字 | 权限 | 说明 |
|------|------|------|
| 7 | rwx | 读、写、执行 |
| 6 | rw- | 读、写 |
| 5 | r-x | 读、执行 |
| 4 | r-- | 只读 |
| 0 | --- | 无权限 |

---

## 日志监控与审计

### 服务器日志分析

服务器日志位于 `logs/` 目录，包含重要的运行信息：

**日志文件**：

- `latest.log`：当前运行日志
- `yyyy-MM-dd-n.log.gz`：历史日志（压缩）

**关注的日志内容**：

```
# 玩家登录
[Server thread/INFO]: PlayerName[/192.168.1.100:12345] logged in

# 玩家登出
[Server thread/INFO]: PlayerName left the game

# 命令执行
[Server thread/INFO]: PlayerName issued server command: /command

# 错误和警告
[Server thread/WARN]: ...
[Server thread/ERROR]: ...
```

**日志分析脚本示例**（Linux）：

```bash
#!/bin/bash
# 统计今日登录玩家
grep "logged in" logs/latest.log | awk '{print $4}' | sort | uniq

# 查找执行的命令
grep "issued server command" logs/latest.log

# 查找错误信息
grep -E "(WARN|ERROR)" logs/latest.log
```

### CoreProtect 方块记录

CoreProtect 是最流行的方块记录插件，可以追踪和回滚玩家操作：

**主要功能**：

- 记录方块放置/破坏
- 记录容器交互
- 记录聊天消息
- 支持回滚和恢复

**基本配置**（`plugins/CoreProtect/config.yml`）：

```yaml
# 数据库设置
use-mysql: false
mysql-host: localhost
mysql-port: 3306
mysql-database: coreprotect
mysql-username: root
mysql-password: password

# 记录设置
block-break: true
block-place: true
block-movement: true
pistons: true
block-burn: true
block-ignite: true
explosions: true
entity-change: true
entity-kills: true
sign-text: true
buckets: true
leaf-decay: true
tree-growth: true
mushroom-growth: true
vine-growth: true
sculk-spread: true
portals: true
water-flow: true
lava-flow: true
liquid-tracking: true
item-drops: true
item-pickups: true
hopper-transactions: true
player-interactions: true
player-messages: true
player-commands: true
player-sessions: true
username-changes: true
worldedit: true

# 数据保留时间（天）
default-time: 3
```

**常用命令**：

| 命令 | 功能 |
|------|------|
| `/co inspect` | 开启/关闭检查模式 |
| `/co lookup u:<玩家> t:<时间> r:<半径>` | 查询操作记录 |
| `/co rollback u:<玩家> t:<时间> r:<半径>` | 回滚操作 |
| `/co restore u:<玩家> t:<时间> r:<半径>` | 恢复已回滚的操作 |
| `/co purge t:<时间>` | 清理旧数据 |

**查询示例**：

```bash
# 查询 Steve 在 1 小时内的操作
/co lookup u:Steve t:1h

# 查询 10 格范围内 24 小时内的方块破坏
/co lookup t:24h r:10 a:block

# 回滚 Steve 在 1 天内的所有操作
/co rollback u:Steve t:1d

# 回滚 TNT 爆炸造成的破坏
/co rollback t:1h a:tnt
```

### 登录日志监控

监控异常登录行为：

**关注的异常情况**：

1. 同一 IP 频繁尝试不同用户名
2. 同一用户名从不同地理位置登录
3. 非正常时间段的登录活动
4. 登录失败次数异常

**使用 Plan 插件进行统计**：

Plan 是一款强大的服务器统计插件，可以追踪玩家活动：

```yaml
# plugins/Plan/config.yml
Webserver:
  Port: 8804
  Alternative_IP: false
  
Data_gathering:
  Geolocations: true
  Ping: true
  
Export:
  HTML_Export: false
```

---

## 常见攻击与应对

### 崩服攻击

崩服攻击利用游戏漏洞使服务器崩溃或无响应。

#### Book Exploit（书本漏洞）

攻击者使用特制的书本物品，包含大量 NBT 数据，导致服务器处理时崩溃。

**防护措施**：

1. 安装 ExploitFixer 或 IllegalStack 插件
2. 限制书本页数和字符数

**ExploitFixer 配置**：

```yaml
# plugins/ExploitFixer/config.yml
book:
  enabled: true
  # 最大页数
  max-pages: 50
  # 每页最大字符数
  max-chars-per-page: 256
```

#### NBT Exploit（NBT 数据漏洞）

攻击者使用包含恶意 NBT 数据的物品，导致服务器或客户端崩溃。

**防护措施**：

1. 安装 IllegalStack 插件
2. 定期清理异常物品

**IllegalStack 配置**：

```yaml
# plugins/IllegalStack/config.yml
# 检查物品 NBT
check-nbt: true
# 最大 NBT 大小（字节）
max-nbt-size: 65536
# 移除非法物品
remove-illegal-items: true
```

#### Chunk Ban（区块封禁）

攻击者在特定区块放置大量实体或方块，导致玩家进入该区块时客户端崩溃。

**防护措施**：

1. 限制每个区块的实体数量
2. 使用 ClearLag 定期清理实体
3. 安装 ChunkBanFix 插件

**spigot.yml 配置**：

```yaml
world-settings:
  default:
    entity-activation-range:
      animals: 32
      monsters: 32
      raiders: 48
      misc: 16
      water: 16
      villagers: 32
      flying-monsters: 32
    # 每个区块最大实体数
    entity-tracking-range:
      players: 48
      animals: 48
      monsters: 48
      misc: 32
      other: 64
```

### 刷物品漏洞

刷物品漏洞允许玩家复制物品，破坏服务器经济平衡。

**常见刷物品方式**：

1. 利用容器和活塞的交互
2. 利用末影箱和死亡机制
3. 利用插件漏洞

**防护措施**：

1. 及时更新服务端和插件
2. 安装反作弊插件（如 Vulcan、Spartan）
3. 使用 IllegalStack 检测异常物品堆叠

**paper.yml 配置**（Paper 服务端）：

```yaml
# 修复常见刷物品漏洞
unsupported-settings:
  allow-piston-duplication: false
  allow-headless-pistons: false
  allow-permanent-block-break-exploits: false
  allow-piston-duplication-tnt: false
```

### 聊天刷屏

攻击者通过快速发送大量消息干扰正常聊天。

**防护措施**：

#### 使用 ChatControl 插件

```yaml
# plugins/ChatControl/settings.yml
Anti_Spam:
  # 启用反刷屏
  Enabled: true
  # 消息间隔（秒）
  Delay: 1
  # 相似消息检测
  Similar_Messages:
    Enabled: true
    # 相似度阈值
    Similarity: 80
  # 大写字母限制
  Caps:
    Enabled: true
    # 最大大写字母比例
    Max_Percentage: 50
    # 最小检测长度
    Min_Length: 5
```

#### 使用 LiteBans 处理违规玩家

```bash
# 临时禁言
/mute <玩家> 10m 刷屏

# 永久禁言
/mute <玩家> 刷屏

# 踢出服务器
/kick <玩家> 请勿刷屏
```

---

## 安全检查清单

定期进行安全检查，确保服务器安全：

### 每日检查

- [ ] 查看服务器日志，关注异常登录和错误
- [ ] 检查在线玩家列表，确认无异常账号
- [ ] 监控服务器资源使用情况

### 每周检查

- [ ] 审查 OP 和管理员列表
- [ ] 检查插件更新
- [ ] 审查权限配置
- [ ] 备份服务器数据

### 每月检查

- [ ] 更新服务端版本
- [ ] 审查防火墙规则
- [ ] 更换敏感密码（RCON、数据库等）
- [ ] 清理过期的白名单和封禁记录
- [ ] 审查并优化安全配置

---

## 总结

服务器安全是一个持续的过程，需要从多个层面进行防护：

1. **访问控制**：使用白名单和正版验证限制访问
2. **网络防护**：配置防火墙，使用 DDoS 防护服务
3. **应用安全**：安装反机器人、反作弊插件
4. **权限管理**：最小权限原则，限制危险命令
5. **监控审计**：记录日志，定期审查

没有绝对安全的系统，但通过合理的配置和持续的维护，可以大大降低安全风险，保障服务器的稳定运行。

