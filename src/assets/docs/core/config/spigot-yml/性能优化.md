# spigot.yml 配置详解 - 性能优化

本文档介绍 spigot.yml 中与性能优化相关的配置选项，包括实体追踪、生物生成、tick 优化等设置。

## 实体追踪范围

实体追踪范围决定了服务器在多远距离内向玩家发送实体信息。超出追踪范围的实体对玩家不可见。

```yaml
world-settings:
  default:
    entity-tracking-range:
      players: 48
      animals: 48
      monsters: 48
      misc: 32
      display: 128
      other: 64
```

---

## entity-tracking-range.players

| 属性 | 值 |
|------|-----|
| 键名 | `world-settings.default.entity-tracking-range.players` |
| 类型 | 整数 |
| 默认值 | `48` |
| 单位 | 方块 |

设置玩家实体的追踪范围。

此值决定了玩家能在多远距离看到其他玩家。较小的值可以减少网络流量，但玩家可能会"突然出现"。

### 建议值

| 服务器类型 | 建议值 |
|-----------|--------|
| PvP 服务器 | 64-128 |
| 生存服务器 | 48 |
| 小游戏服务器 | 32-48 |

---

## entity-tracking-range.animals

| 属性 | 值 |
|------|-----|
| 键名 | `world-settings.default.entity-tracking-range.animals` |
| 类型 | 整数 |
| 默认值 | `48` |
| 单位 | 方块 |

设置动物实体的追踪范围。

降低此值可以减少网络流量，但远处的动物对玩家不可见。

---

## entity-tracking-range.monsters

| 属性 | 值 |
|------|-----|
| 键名 | `world-settings.default.entity-tracking-range.monsters` |
| 类型 | 整数 |
| 默认值 | `48` |
| 单位 | 方块 |

设置怪物实体的追踪范围。

### 注意事项

- 追踪范围应大于或等于激活范围
- 过小的追踪范围可能导致怪物"突然出现"在玩家面前

---

## entity-tracking-range.misc

| 属性 | 值 |
|------|-----|
| 键名 | `world-settings.default.entity-tracking-range.misc` |
| 类型 | 整数 |
| 默认值 | `32` |
| 单位 | 方块 |

设置杂项实体（物品、经验球等）的追踪范围。

---

## entity-tracking-range.display

| 属性 | 值 |
|------|-----|
| 键名 | `world-settings.default.entity-tracking-range.display` |
| 类型 | 整数 |
| 默认值 | `128` |
| 单位 | 方块 |

设置展示实体（Display Entity，1.19.4+ 新增）的追踪范围。

展示实体通常用于地图装饰或插件创建的视觉效果，较大的追踪范围可以让玩家从更远处看到这些效果。

---

## entity-tracking-range.other

| 属性 | 值 |
|------|-----|
| 键名 | `world-settings.default.entity-tracking-range.other` |
| 类型 | 整数 |
| 默认值 | `64` |
| 单位 | 方块 |

设置其他未分类实体的追踪范围。

---

## 村民优化

村民是 Minecraft 中 AI 最复杂的实体之一，Spigot 提供了多个选项来优化村民性能。

```yaml
world-settings:
  default:
    entity-activation-range:
      villagers-work-immunity-after: 100
      villagers-work-immunity-for: 20
      villagers-active-for-panic: true
      tick-inactive-villagers: true
```

---

## villagers-work-immunity-after

| 属性 | 值 |
|------|-----|
| 键名 | `world-settings.default.entity-activation-range.villagers-work-immunity-after` |
| 类型 | 整数 |
| 默认值 | `100` |
| 单位 | tick |

设置村民在工作后获得激活豁免的时间。

当村民完成工作后，会在指定 tick 内保持激活状态，即使超出激活范围。这确保村民能完成完整的工作周期。

---

## villagers-work-immunity-for

| 属性 | 值 |
|------|-----|
| 键名 | `world-settings.default.entity-activation-range.villagers-work-immunity-for` |
| 类型 | 整数 |
| 默认值 | `20` |
| 单位 | tick |

设置村民工作豁免的持续时间。

---

## villagers-active-for-panic

| 属性 | 值 |
|------|-----|
| 键名 | `world-settings.default.entity-activation-range.villagers-active-for-panic` |
| 类型 | 布尔值 |
| 默认值 | `true` |

控制村民在恐慌状态时是否保持激活。

- `true`：村民在恐慌（被攻击、遇到僵尸等）时保持激活
- `false`：村民恐慌时也遵循激活范围限制

建议保持 `true`，否则村民可能在危险中"冻结"。

---

## tick-inactive-villagers

| 属性 | 值 |
|------|-----|
| 键名 | `world-settings.default.entity-activation-range.tick-inactive-villagers` |
| 类型 | 布尔值 |
| 默认值 | `true` |

控制是否对不活跃的村民进行 tick 处理。

- `true`：即使村民不活跃，也会进行基本的 tick 处理（如补货）
- `false`：不活跃的村民完全停止 tick

### 影响

设置为 `false` 可以提升性能，但可能导致：
- 村民不补货
- 村民不更新交易
- 铁傀儡农场效率降低

---

## 唤醒不活跃实体

Spigot 提供了定期唤醒不活跃实体的机制，确保它们不会永远"冻结"。

```yaml
world-settings:
  default:
    entity-activation-range:
      wake-up-inactive:
        animals-max-per-tick: 4
        animals-every: 1200
        animals-for: 100
        monsters-max-per-tick: 8
        monsters-every: 400
        monsters-for: 100
        villagers-max-per-tick: 4
        villagers-every: 600
        villagers-for: 100
        flying-monsters-max-per-tick: 8
        flying-monsters-every: 200
        flying-monsters-for: 100
```

### 参数说明

- `*-max-per-tick`：每 tick 最多唤醒多少个该类型实体
- `*-every`：每隔多少 tick 执行一次唤醒
- `*-for`：唤醒后保持活跃多少 tick

---

## 物品合并

物品合并可以将地面上相近的同类物品合并为一个实体，减少实体数量。

```yaml
world-settings:
  default:
    merge-radius:
      item: 2.5
      exp: 3.0
```

---

## merge-radius.item

| 属性 | 值 |
|------|-----|
| 键名 | `world-settings.default.merge-radius.item` |
| 类型 | 小数 |
| 默认值 | `2.5` |
| 单位 | 方块 |

设置物品实体的合并半径。

在此半径内的同类物品会自动合并为一个物品堆。

### 调整建议

| 值 | 效果 |
|----|------|
| 0 | 禁用物品合并 |
| 2.5 | 默认值，平衡性能和体验 |
| 4.0+ | 更激进的合并，可能影响物品分拣机 |

### 注意事项

过大的合并半径可能影响：
- 物品分拣系统
- 漏斗收集效率
- 玩家拾取体验

---

## merge-radius.exp

| 属性 | 值 |
|------|-----|
| 键名 | `world-settings.default.merge-radius.exp` |
| 类型 | 小数 |
| 默认值 | `3.0` |
| 单位 | 方块 |

设置经验球的合并半径。

经验球合并对性能提升明显，因为击杀怪物或挖矿时会产生大量经验球。

---

## 生物生成限制

```yaml
world-settings:
  default:
    mob-spawn-range: 8
```

---

## mob-spawn-range

| 属性 | 值 |
|------|-----|
| 键名 | `world-settings.default.mob-spawn-range` |
| 类型 | 整数 |
| 默认值 | `8` |
| 单位 | 区块 |

设置生物生成的范围（以区块为单位）。

生物只会在玩家周围指定区块范围内生成。此值应小于或等于视距。

### 与视距的关系

```
mob-spawn-range ≤ view-distance
```

如果生成范围大于视距，超出视距的生物会立即消失，浪费服务器资源。

### 建议值

| 视距 | 建议生成范围 |
|------|-------------|
| 6 | 4-6 |
| 8 | 6-8 |
| 10 | 6-8 |
| 12 | 8 |

---

## 漏斗优化

```yaml
world-settings:
  default:
    hopper-amount: 1
    hopper-can-load-chunks: false
```

---

## hopper-amount

| 属性 | 值 |
|------|-----|
| 键名 | `world-settings.default.hopper-amount` |
| 类型 | 整数 |
| 默认值 | `1` |

设置漏斗每次传输的物品数量。

- `1`：每次传输 1 个物品（原版行为）
- `> 1`：每次传输多个物品，减少漏斗 tick 次数

### 性能影响

增大此值可以减少漏斗的 tick 频率，提升性能。但可能影响某些依赖精确时序的红石机器。

---

## hopper-can-load-chunks

| 属性 | 值 |
|------|-----|
| 键名 | `world-settings.default.hopper-can-load-chunks` |
| 类型 | 布尔值 |
| 默认值 | `false` |

控制漏斗是否可以加载区块。

- `true`：漏斗可以加载相邻区块以完成传输
- `false`：漏斗不会加载区块，跨区块传输可能失败

### 建议

保持 `false` 以避免漏斗导致的区块加载问题。如果你的服务器有跨区块的漏斗系统，可能需要设置为 `true`。

---

## 箭矢优化

```yaml
world-settings:
  default:
    arrow-despawn-rate: 1200
    trident-despawn-rate: 1200
```

---

## arrow-despawn-rate

| 属性 | 值 |
|------|-----|
| 键名 | `world-settings.default.arrow-despawn-rate` |
| 类型 | 整数 |
| 默认值 | `1200` |
| 单位 | tick |

设置箭矢的消失时间。

- `1200`：60 秒后消失（默认）
- 较小的值：箭矢更快消失，减少实体数量
- `-1`：禁用自动消失

### 建议值

| 服务器类型 | 建议值 |
|-----------|--------|
| 普通服务器 | 1200 |
| PvP 服务器 | 300-600 |
| 性能优先 | 200-400 |

---

## trident-despawn-rate

| 属性 | 值 |
|------|-----|
| 键名 | `world-settings.default.trident-despawn-rate` |
| 类型 | 整数 |
| 默认值 | `1200` |
| 单位 | tick |

设置三叉戟的消失时间。

由于三叉戟是稀有物品，建议保持较长的消失时间或使用忠诚附魔。

---

## 区块生成优化

```yaml
world-settings:
  default:
    nerf-spawner-mobs: false
```

---

## nerf-spawner-mobs

| 属性 | 值 |
|------|-----|
| 键名 | `world-settings.default.nerf-spawner-mobs` |
| 类型 | 布尔值 |
| 默认值 | `false` |

控制是否削弱刷怪笼生成的生物。

- `true`：刷怪笼生成的生物没有 AI，不会移动或攻击
- `false`：刷怪笼生成的生物正常行为

### 使用场景

启用此选项可以大幅提升刷怪塔的性能，但会改变游戏体验：
- 怪物不会走向玩家
- 需要使用水流等方式移动怪物
- 某些刷怪塔设计可能失效

---

## 性能优化建议汇总

### 低配服务器（2GB 内存以下）

```yaml
world-settings:
  default:
    view-distance: 6
    simulation-distance: 4
    entity-activation-range:
      animals: 16
      monsters: 24
      misc: 8
      water: 8
      villagers: 16
    entity-tracking-range:
      players: 48
      animals: 32
      monsters: 32
      misc: 16
    merge-radius:
      item: 4.0
      exp: 6.0
    mob-spawn-range: 4
    arrow-despawn-rate: 300
    nerf-spawner-mobs: true
```

### 中配服务器（4-8GB 内存）

```yaml
world-settings:
  default:
    view-distance: 8
    simulation-distance: 6
    entity-activation-range:
      animals: 24
      monsters: 32
      misc: 12
      water: 12
      villagers: 24
    entity-tracking-range:
      players: 48
      animals: 48
      monsters: 48
      misc: 24
    merge-radius:
      item: 3.0
      exp: 4.0
    mob-spawn-range: 6
    arrow-despawn-rate: 600
```

### 高配服务器（8GB+ 内存）

```yaml
world-settings:
  default:
    view-distance: 10
    simulation-distance: 8
    entity-activation-range:
      animals: 32
      monsters: 32
      misc: 16
      water: 16
      villagers: 32
    # 其他保持默认值
```

---

## 相关文档

- [世界设置](世界设置.md) - 实体激活范围详细说明
- [基础设置](基础设置.md) - 全局配置选项
