# Paper 区块系统配置

本文档介绍 Paper 中与区块加载、生成和处理相关的配置项。这些配置对服务器性能有重要影响。

## paper-global.yml 中的区块配置

### async-chunks（异步区块）

异步区块处理相关配置。

```yaml
async-chunks:
  threads: -1
```

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `threads` | `-1` | 用于异步区块操作的线程数。`-1` 表示自动根据 CPU 核心数决定 |

:::tip 建议
对于大多数服务器，保持默认值 `-1` 即可。Paper 会根据你的 CPU 核心数自动选择合适的线程数。
:::

### chunk-loading（区块加载）

区块加载相关配置，对服务器性能有重要影响。

```yaml
chunk-loading:
  autoconfig-send-distance: true
  enable-frustum-priority: false
  global-max-chunk-load-rate: -1.0
  global-max-chunk-send-rate: -1.0
  global-max-concurrent-loads: 500.0
  max-concurrent-sends: 2
  min-load-radius: 2
  player-max-chunk-load-rate: -1.0
  player-max-concurrent-loads: 20.0
  target-player-chunk-send-rate: 100.0
```

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `autoconfig-send-distance` | `true` | 自动配置区块发送距离。启用时会根据服务器性能自动调整 |
| `enable-frustum-priority` | `false` | 启用视锥体优先级，优先加载玩家视野内的区块 |
| `global-max-chunk-load-rate` | `-1.0` | 全局每秒最大区块加载数，`-1` 为不限制 |
| `global-max-chunk-send-rate` | `-1.0` | 全局每秒最大区块发送数，`-1` 为不限制 |
| `global-max-concurrent-loads` | `500.0` | 全局最大并发区块加载数 |
| `max-concurrent-sends` | `2` | 每个玩家的最大并发区块发送数 |
| `min-load-radius` | `2` | 最小加载半径（区块） |
| `player-max-chunk-load-rate` | `-1.0` | 每个玩家每秒最大区块加载数，`-1` 为不限制 |
| `player-max-concurrent-loads` | `20.0` | 每个玩家的最大并发区块加载数 |
| `target-player-chunk-send-rate` | `100.0` | 目标玩家区块发送速率（每秒） |

#### 性能优化建议

如果服务器在玩家移动时出现卡顿，可以尝试：

```yaml
chunk-loading:
  global-max-chunk-load-rate: 300.0
  player-max-chunk-load-rate: 40.0
  global-max-concurrent-loads: 300.0
  player-max-concurrent-loads: 10.0
```

### chunk-system（区块系统）

区块系统的核心配置。

```yaml
chunk-system:
  gen-parallelism: default
  io-threads: -1
  worker-threads: -1
```

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `gen-parallelism` | `default` | 区块生成并行度。可选 `default`、`on`、`off` |
| `io-threads` | `-1` | 区块 I/O 线程数，`-1` 为自动 |
| `worker-threads` | `-1` | 区块工作线程数，`-1` 为自动 |

:::info 说明
- `gen-parallelism: default` - 使用默认的并行生成策略
- `gen-parallelism: on` - 强制启用并行区块生成
- `gen-parallelism: off` - 禁用并行区块生成（可能解决某些兼容性问题）
:::

---

## paper-world-defaults.yml 中的区块配置

### chunks（区块）

世界级别的区块配置。

```yaml
chunks:
  auto-save-interval: default
  delay-chunk-unloads-by: 10s
  entity-per-chunk-save-limit:
    arrow: -1
    ender_pearl: -1
    experience_orb: -1
    fireball: -1
    small_fireball: -1
    snowball: -1
  fixed-chunk-inhabited-time: -1
  flush-regions-on-save: false
  max-auto-save-chunks-per-tick: 24
  prevent-moving-into-unloaded-chunks: false
```

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `auto-save-interval` | `default` | 区块自动保存间隔，`default` 使用全局设置 |
| `delay-chunk-unloads-by` | `10s` | 延迟卸载区块的时间，防止频繁加载卸载 |
| `fixed-chunk-inhabited-time` | `-1` | 固定区块居住时间，`-1` 为正常计算 |
| `flush-regions-on-save` | `false` | 保存时是否刷新区域文件 |
| `max-auto-save-chunks-per-tick` | `24` | 每 tick 最多自动保存的区块数 |
| `prevent-moving-into-unloaded-chunks` | `false` | 是否阻止玩家移动到未加载的区块 |

#### entity-per-chunk-save-limit（每区块实体保存限制）

限制每个区块保存的特定实体数量，防止实体堆积导致的性能问题。

```yaml
entity-per-chunk-save-limit:
  arrow: 16
  ender_pearl: 8
  experience_orb: 16
  fireball: 8
  small_fireball: 8
  snowball: 8
```

| 实体类型 | 推荐值 | 说明 |
|----------|--------|------|
| `arrow` | `16` | 箭矢 |
| `ender_pearl` | `8` | 末影珍珠 |
| `experience_orb` | `16` | 经验球 |
| `fireball` | `8` | 火球 |
| `small_fireball` | `8` | 小火球 |
| `snowball` | `8` | 雪球 |

:::tip 性能优化
设置合理的实体保存限制可以防止某些区块因为堆积大量实体而导致加载缓慢。`-1` 表示不限制。
:::

### 区块加载优化建议

1. **延迟卸载**：增加 `delay-chunk-unloads-by` 可以减少频繁的区块加载/卸载操作
   ```yaml
   delay-chunk-unloads-by: 30s
   ```

2. **限制自动保存**：降低 `max-auto-save-chunks-per-tick` 可以减少保存时的卡顿
   ```yaml
   max-auto-save-chunks-per-tick: 12
   ```

3. **阻止进入未加载区块**：启用此选项可以防止玩家因移动过快而进入未加载区块
   ```yaml
   prevent-moving-into-unloaded-chunks: true
   ```

---

## 区块预生成

对于新服务器，建议在开服前预生成区块，避免玩家探索时造成的卡顿。

### 使用 Chunky 插件

[Chunky](https://www.spigotmc.org/resources/chunky.81534/) 是最流行的区块预生成插件：

```
/chunky radius 5000
/chunky start
```

### 预生成建议

- **主世界**：预生成 5000-10000 格半径
- **下界**：预生成 1000-2000 格半径（下界距离是主世界的 1/8）
- **末地**：通常不需要大范围预生成

:::warning 注意
区块预生成会占用大量 CPU 和磁盘资源，建议在服务器空闲时进行，或在开服前完成。
:::
