# Paper 反矿透（Anti-Xray）配置详解

反矿透是 Paper 内置的防作弊功能，用于防止玩家使用矿透材质包或作弊客户端透视矿物。本文档详细介绍 anti-xray 的配置方法。

## 基本概念

### 什么是矿透

矿透（X-Ray）是一种作弊方式，通过修改客户端或使用特殊材质包，让玩家能够透过方块看到矿物的位置。这严重破坏了游戏的公平性。

### Paper 的解决方案

Paper 提供了两种反矿透引擎模式：

| 模式 | 原理 | 性能影响 | 效果 |
|------|------|----------|------|
| **Engine Mode 1** | 将隐藏的矿物替换为石头发送给客户端 | 较低 | 基础防护 |
| **Engine Mode 2** | 将所有石头替换为随机矿物发送给客户端 | 较高 | 高级防护 |

---

## 配置位置

反矿透配置位于 `paper-world-defaults.yml` 的 `anticheat.anti-xray` 部分：

```yaml
anticheat:
  anti-xray:
    enabled: false
    engine-mode: 1
    hidden-blocks:
      - copper_ore
      - deepslate_copper_ore
      - raw_copper_block
      - gold_ore
      - deepslate_gold_ore
      - iron_ore
      - deepslate_iron_ore
      - raw_iron_block
      - coal_ore
      - deepslate_coal_ore
      - lapis_ore
      - deepslate_lapis_ore
      - mossy_cobblestone
      - obsidian
      - chest
      - diamond_ore
      - deepslate_diamond_ore
      - redstone_ore
      - deepslate_redstone_ore
      - clay
      - emerald_ore
      - deepslate_emerald_ore
      - ender_chest
    lava-obscures: false
    max-block-height: 64
    replacement-blocks:
      - stone
      - oak_planks
      - deepslate
    update-radius: 2
    use-permission: false
```

---

## Engine Mode 1（基础模式）

### 工作原理

Engine Mode 1 会将 `hidden-blocks` 列表中的方块替换为 `replacement-blocks` 列表中的方块发送给客户端。只有当玩家靠近或方块被暴露时，才会发送真实的方块数据。

### 推荐配置

```yaml
anticheat:
  anti-xray:
    enabled: true
    engine-mode: 1
    hidden-blocks:
      # 主世界矿物
      - coal_ore
      - deepslate_coal_ore
      - copper_ore
      - deepslate_copper_ore
      - iron_ore
      - deepslate_iron_ore
      - gold_ore
      - deepslate_gold_ore
      - redstone_ore
      - deepslate_redstone_ore
      - lapis_ore
      - deepslate_lapis_ore
      - diamond_ore
      - deepslate_diamond_ore
      - emerald_ore
      - deepslate_emerald_ore
      # 原矿块
      - raw_copper_block
      - raw_iron_block
      - raw_gold_block
      # 其他有价值的方块
      - chest
      - ender_chest
      - spawner
      - ancient_debris
    lava-obscures: false
    max-block-height: 64
    replacement-blocks:
      - stone
      - deepslate
    update-radius: 2
    use-permission: false
```

### 优缺点

**优点：**
- 性能影响较小
- 配置简单
- 适合大多数服务器

**缺点：**
- 作弊者仍能看到"空洞"（被替换的区域）
- 有经验的作弊者可能通过空洞判断矿物位置

---

## Engine Mode 2（高级模式）

### 工作原理

Engine Mode 2 会将所有 `replacement-blocks` 列表中的方块随机替换为 `hidden-blocks` 列表中的方块。这意味着作弊者看到的是满屏的"假矿物"，无法分辨真假。

### 推荐配置

```yaml
anticheat:
  anti-xray:
    enabled: true
    engine-mode: 2
    hidden-blocks:
      # 主世界矿物（会随机显示）
      - coal_ore
      - copper_ore
      - iron_ore
      - gold_ore
      - redstone_ore
      - lapis_ore
      - diamond_ore
      - emerald_ore
      # 深层矿物
      - deepslate_coal_ore
      - deepslate_copper_ore
      - deepslate_iron_ore
      - deepslate_gold_ore
      - deepslate_redstone_ore
      - deepslate_lapis_ore
      - deepslate_diamond_ore
      - deepslate_emerald_ore
    lava-obscures: false
    max-block-height: 64
    replacement-blocks:
      # 会被替换的方块
      - stone
      - deepslate
      - andesite
      - diorite
      - granite
      - tuff
    update-radius: 2
    use-permission: false
```

### 优缺点

**优点：**
- 防护效果最好
- 作弊者看到满屏假矿物，完全无法判断

**缺点：**
- 性能影响较大（需要更多带宽）
- 可能导致客户端轻微卡顿

---

## 下界配置

下界需要单独配置，因为下界的矿物和方块不同。

在 `world_nether/paper-world.yml` 中：

```yaml
anticheat:
  anti-xray:
    enabled: true
    engine-mode: 1
    hidden-blocks:
      - ancient_debris
      - nether_gold_ore
      - nether_quartz_ore
    lava-obscures: true
    max-block-height: 128
    replacement-blocks:
      - netherrack
    update-radius: 2
```

:::tip 提示
下界建议使用 Engine Mode 1，因为下界的方块种类较少，Mode 2 的效果不如主世界明显。
:::

---

## 末地配置

末地通常不需要反矿透，因为末地没有矿物。但如果你的服务器在末地有特殊内容，可以配置：

```yaml
anticheat:
  anti-xray:
    enabled: false
```

---

## 配置项详解

### enabled

```yaml
enabled: true
```

是否启用反矿透。设为 `true` 启用。

### engine-mode

```yaml
engine-mode: 1
```

引擎模式，可选 `1` 或 `2`。详见上文。

### hidden-blocks

```yaml
hidden-blocks:
  - diamond_ore
  - gold_ore
  # ...
```

需要隐藏的方块列表。

- **Mode 1**：这些方块会被替换为 `replacement-blocks` 中的方块
- **Mode 2**：这些方块会随机出现在 `replacement-blocks` 的位置

### replacement-blocks

```yaml
replacement-blocks:
  - stone
  - deepslate
```

替换方块列表。

- **Mode 1**：用于替换 `hidden-blocks` 中的方块
- **Mode 2**：这些方块会被随机替换为 `hidden-blocks` 中的方块

### lava-obscures

```yaml
lava-obscures: false
```

岩浆是否能遮挡方块。设为 `true` 时，被岩浆包围的方块也会被隐藏。

- 主世界建议 `false`
- 下界建议 `true`（下界有大量岩浆）

### max-block-height

```yaml
max-block-height: 64
```

反矿透生效的最大高度。高于此高度的方块不会被处理。

- 主世界建议 `64`（大部分矿物在此高度以下）
- 下界建议 `128`

### update-radius

```yaml
update-radius: 2
```

更新半径。当方块被破坏时，周围多少格内的方块会更新为真实状态。

- 建议保持默认值 `2`
- 增大此值会增加网络流量

### use-permission

```yaml
use-permission: false
```

是否使用权限控制。设为 `true` 时，拥有 `paper.antixray.bypass` 权限的玩家不受反矿透影响。

:::warning 警告
不建议给普通玩家此权限，否则反矿透将失效。
:::

---

## 性能优化建议

### 降低性能影响

1. **使用 Mode 1**：如果服务器性能有限，使用 Mode 1
2. **限制高度**：降低 `max-block-height` 可以减少处理的方块数
3. **减少隐藏方块**：只隐藏最重要的矿物

### 推荐的平衡配置

```yaml
anticheat:
  anti-xray:
    enabled: true
    engine-mode: 1
    hidden-blocks:
      - diamond_ore
      - deepslate_diamond_ore
      - emerald_ore
      - deepslate_emerald_ore
      - ancient_debris
      - spawner
      - chest
    lava-obscures: false
    max-block-height: 64
    replacement-blocks:
      - stone
      - deepslate
    update-radius: 2
    use-permission: false
```

---

## 常见问题

### Q: 反矿透会影响正常玩家吗？

A: 不会。正常玩家看到的方块是正确的，只有使用矿透的玩家才会看到假方块。

### Q: 为什么我启用了反矿透但作弊者还能找到矿物？

A: 可能的原因：
1. 配置不正确，检查 `enabled: true`
2. 使用了 Mode 1，作弊者通过空洞判断
3. `max-block-height` 设置过低

### Q: Engine Mode 2 会导致客户端卡顿吗？

A: 可能会有轻微影响，因为需要发送更多的方块数据。如果玩家反馈卡顿，可以考虑切换到 Mode 1。

### Q: 如何测试反矿透是否生效？

A: 
1. 安装一个矿透材质包
2. 进入服务器查看效果
3. Mode 1：矿物应该显示为石头
4. Mode 2：应该看到满屏的假矿物
