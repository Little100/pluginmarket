# Paper 实体优化配置

本文档介绍 Paper 中与实体相关的优化配置，包括消失范围、保存限制、生成优化等。合理配置这些选项可以显著提升服务器性能。

## 实体消失范围（despawn-ranges）

控制生物在多远距离外会消失，这是最重要的实体优化配置之一。

```yaml
entities:
  spawning:
    despawn-ranges:
      ambient:
        hard: 128
        soft: 32
      axolotls:
        hard: 128
        soft: 32
      creature:
        hard: 128
        soft: 32
      misc:
        hard: 128
        soft: 32
      monster:
        hard: 128
        soft: 32
      underground_water_creature:
        hard: 128
        soft: 32
      water_ambient:
        hard: 64
        soft: 32
      water_creature:
        hard: 128
        soft: 32
```

### 消失范围说明

| 参数 | 说明 |
|------|------|
| `soft` | 软消失范围。超过此距离的生物有概率消失 |
| `hard` | 硬消失范围。超过此距离的生物立即消失 |

### 生物类型说明

| 类型 | 包含的生物 |
|------|------------|
| `ambient` | 蝙蝠等环境生物 |
| `axolotls` | 美西螈 |
| `creature` | 被动生物（牛、羊、猪等） |
| `misc` | 杂项实体 |
| `monster` | 敌对生物（僵尸、骷髅等） |
| `underground_water_creature` | 地下水生生物（发光鱿鱼） |
| `water_ambient` | 水中环境生物（热带鱼等） |
| `water_creature` | 水中生物（鱿鱼、海豚等） |

### 推荐的优化配置

```yaml
despawn-ranges:
  ambient:
    hard: 72
    soft: 28
  axolotls:
    hard: 72
    soft: 28
  creature:
    hard: 72
    soft: 28
  misc:
    hard: 72
    soft: 28
  monster:
    hard: 72
    soft: 28
  underground_water_creature:
    hard: 72
    soft: 28
  water_ambient:
    hard: 56
    soft: 28
  water_creature:
    hard: 72
    soft: 28
```

:::tip 性能提示
降低消失范围可以显著减少服务器需要处理的实体数量。建议将 `hard` 设为视距的 1.5 倍左右。
:::

---

## 每区块实体保存限制（entity-per-chunk-save-limit）

限制每个区块保存的特定实体数量，防止实体堆积。

```yaml
chunks:
  entity-per-chunk-save-limit:
    arrow: -1
    ender_pearl: -1
    experience_orb: -1
    fireball: -1
    small_fireball: -1
    snowball: -1
```

### 推荐配置

```yaml
entity-per-chunk-save-limit:
  arrow: 16
  ender_pearl: 8
  experience_orb: 16
  fireball: 8
  small_fireball: 8
  snowball: 8
  egg: 8
  trident: 8
  llama_spit: 3
  dragon_fireball: 3
  shulker_bullet: 8
```

:::warning 注意
`-1` 表示不限制。如果某个区块堆积了大量箭矢或经验球，可能导致该区块加载缓慢。
:::

---

## 每玩家生物生成（per-player-mob-spawns）

控制生物生成是否按玩家计算。

```yaml
entities:
  spawning:
    per-player-mob-spawns: true
```

| 值 | 说明 |
|----|------|
| `true` | 每个玩家独立计算生物上限（推荐） |
| `false` | 全服共享生物上限 |

:::tip 推荐
启用 `per-player-mob-spawns` 可以让每个玩家都有公平的生物生成体验，避免某些玩家因为其他玩家的刷怪塔而无法遇到生物。
:::

---

## 生物生成上限

控制各类生物的生成上限。

```yaml
entities:
  spawning:
    spawn-limits:
      ambient: 15
      axolotls: 5
      creature: 10
      monster: 70
      underground_water_creature: 5
      water_ambient: 20
      water_creature: 5
```

### 推荐的优化配置

```yaml
spawn-limits:
  ambient: 1        # 蝙蝠几乎不需要
  axolotls: 3
  creature: 8
  monster: 50       # 降低怪物数量
  underground_water_creature: 3
  water_ambient: 10
  water_creature: 3
```

---

## 实体激活范围（entity-activation-range）

控制实体在多远距离内会被激活（执行 AI）。

```yaml
entities:
  activation-range:
    animals: 32
    flying-monsters: 32
    ignore-spectators: false
    misc: 16
    monsters: 32
    raiders: 64
    tick-inactive-villagers: true
    villagers: 32
    wake-up-inactive:
      animals-every: 1200
      animals-for: 100
      animals-max-per-tick: 4
      flying-monsters-every: 200
      flying-monsters-for: 100
      flying-monsters-max-per-tick: 8
      monsters-every: 400
      monsters-for: 100
      monsters-max-per-tick: 8
      villagers-every: 600
      villagers-for: 100
      villagers-max-per-tick: 4
    water: 16
```

### 激活范围说明

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `animals` | `32` | 动物的激活范围 |
| `monsters` | `32` | 怪物的激活范围 |
| `villagers` | `32` | 村民的激活范围 |
| `flying-monsters` | `32` | 飞行怪物（幻翼等）的激活范围 |
| `raiders` | `64` | 袭击者的激活范围 |
| `water` | `16` | 水生生物的激活范围 |
| `misc` | `16` | 杂项实体的激活范围 |

### 推荐的优化配置

```yaml
activation-range:
  animals: 16
  flying-monsters: 48
  misc: 8
  monsters: 24
  raiders: 48
  villagers: 24
  water: 8
```

:::warning 注意
过度降低激活范围可能导致：
- 怪物不会主动攻击玩家
- 动物不会繁殖
- 村民不会工作
:::

---

## 村民优化

村民是服务器性能的主要消耗者之一。

```yaml
entities:
  activation-range:
    tick-inactive-villagers: true
    villagers: 32
```

### tick-inactive-villagers

| 值 | 说明 |
|----|------|
| `true` | 即使村民不在激活范围内，也会执行基本的 tick（如补货） |
| `false` | 不在激活范围内的村民完全停止 tick |

### 村民优化建议

1. **限制村民数量**：每个村庄不要超过 20 个村民
2. **使用工作站**：确保每个村民都有对应的工作站
3. **避免大型交易大厅**：将村民分散到多个区块

---

## 实体碰撞优化

```yaml
collisions:
  allow-player-cramming-damage: false
  allow-vehicle-collisions: true
  fix-climbing-bypassing-cramming-rule: false
  max-entity-collisions: 8
  only-players-collide: false
```

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `max-entity-collisions` | `8` | 每个实体每 tick 最多处理的碰撞数 |
| `only-players-collide` | `false` | 是否只有玩家会发生碰撞 |

### 推荐配置

```yaml
collisions:
  max-entity-collisions: 2
```

降低 `max-entity-collisions` 可以减少实体碰撞计算，提升性能。

---

## 实体追踪优化

```yaml
entities:
  tracking-range-y:
    animal: 48
    display: 128
    misc: 32
    monster: 48
    other: 64
    player: 48
```

追踪范围控制实体在多远距离内会被发送给客户端。

### 推荐配置

```yaml
tracking-range-y:
  animal: 32
  display: 64
  misc: 16
  monster: 32
  other: 48
  player: 48
```

---

## 综合优化配置示例

以下是一个综合的实体优化配置：

```yaml
entities:
  activation-range:
    animals: 16
    flying-monsters: 48
    misc: 8
    monsters: 24
    raiders: 48
    tick-inactive-villagers: true
    villagers: 24
    water: 8
  spawning:
    despawn-ranges:
      ambient:
        hard: 56
        soft: 28
      creature:
        hard: 72
        soft: 28
      monster:
        hard: 72
        soft: 28
    per-player-mob-spawns: true
    spawn-limits:
      ambient: 1
      creature: 8
      monster: 50

collisions:
  max-entity-collisions: 2

chunks:
  entity-per-chunk-save-limit:
    arrow: 16
    experience_orb: 16
```

:::tip 性能监控
使用 `/spark profiler` 命令可以查看实体处理占用的性能比例，帮助你针对性地优化配置。
:::
