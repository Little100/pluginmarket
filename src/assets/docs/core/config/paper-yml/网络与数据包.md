# Paper 网络与数据包配置

本文档介绍 Paper 中与网络通信、数据包处理和代理服务器相关的配置项。

## packet-limiter（数据包限制）

数据包限制器用于防止恶意客户端发送大量数据包导致服务器崩溃。

```yaml
packet-limiter:
  all-packets:
    action: KICK
    interval: 7.0
    max-packet-rate: 500.0
  kick-message: <red><lang:disconnect.exceeded_packet_rate>
  overrides:
    ServerboundPlaceRecipePacket:
      action: DROP
      interval: 4.0
      max-packet-rate: 5.0
```

### 全局数据包限制

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `all-packets.action` | `KICK` | 超过限制时的动作：`KICK`（踢出）或 `DROP`（丢弃） |
| `all-packets.interval` | `7.0` | 检测间隔（秒） |
| `all-packets.max-packet-rate` | `500.0` | 每秒最大数据包数 |
| `kick-message` | `<red>...` | 因数据包过多被踢出时的消息 |

### 特定数据包覆盖

`overrides` 部分可以为特定类型的数据包设置不同的限制：

```yaml
overrides:
  ServerboundPlaceRecipePacket:
    action: DROP
    interval: 4.0
    max-packet-rate: 5.0
```

常见需要限制的数据包类型：

| 数据包类型 | 说明 | 推荐设置 |
|------------|------|----------|
| `ServerboundPlaceRecipePacket` | 配方放置请求 | `max-packet-rate: 5.0` |
| `ServerboundContainerClickPacket` | 容器点击 | `max-packet-rate: 50.0` |
| `ServerboundMovePlayerPacket` | 玩家移动 | 通常不需要限制 |

:::warning 注意
过于严格的数据包限制可能导致正常玩家被误踢。建议先使用 `DROP` 动作测试，确认无误后再改为 `KICK`。
:::

---

## proxies（代理服务器）

代理服务器相关配置，用于支持 BungeeCord 和 Velocity 等代理。

### BungeeCord 配置

```yaml
proxies:
  bungee-cord:
    online-mode: true
  proxy-protocol: false
```

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `bungee-cord.online-mode` | `true` | BungeeCord 的在线模式。如果使用 BungeeCord，需要在 `spigot.yml` 中启用 `bungeecord: true` |
| `proxy-protocol` | `false` | 是否启用 PROXY 协议（用于某些网络架构） |

### Velocity 配置

```yaml
proxies:
  velocity:
    enabled: false
    online-mode: false
    secret: ''
```

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `velocity.enabled` | `false` | 是否启用 Velocity 支持 |
| `velocity.online-mode` | `false` | Velocity 的在线模式 |
| `velocity.secret` | `''` | Velocity 转发密钥，必须与 Velocity 配置中的 `forwarding-secret` 一致 |

#### 配置 Velocity 支持

1. 在 Velocity 的 `velocity.toml` 中设置：
   ```toml
   player-info-forwarding-mode = "modern"
   ```

2. 复制 Velocity 的 `forwarding.secret` 文件内容

3. 在 Paper 的 `paper-global.yml` 中配置：
   ```yaml
   proxies:
     velocity:
       enabled: true
       online-mode: true
       secret: '你的密钥'
   ```

:::tip 推荐
Velocity 是比 BungeeCord 更现代、更安全的代理解决方案。如果你正在搭建新的群组服，推荐使用 Velocity。
:::

---

## 网络相关的其他配置

### 连接限制

在 `server.properties` 中：

```properties
# 最大玩家数
max-players=20

# 网络压缩阈值（字节）
network-compression-threshold=256
```

### 视距和模拟距离

```properties
# 视距（区块）
view-distance=10

# 模拟距离（区块）
simulation-distance=10
```

:::info 说明
- **视距**：玩家能看到的区块范围
- **模拟距离**：实体和红石等会被模拟的区块范围

降低这些值可以显著提升服务器性能，但会影响玩家体验。
:::

### 推荐的网络优化配置

对于大型服务器，建议：

```yaml
# paper-global.yml
packet-limiter:
  all-packets:
    action: KICK
    interval: 7.0
    max-packet-rate: 500.0
  overrides:
    ServerboundPlaceRecipePacket:
      action: DROP
      interval: 4.0
      max-packet-rate: 5.0
```

```properties
# server.properties
network-compression-threshold=256
view-distance=8
simulation-distance=6
```

---

## 常见网络问题排查

### 玩家频繁掉线

1. 检查 `packet-limiter` 设置是否过于严格
2. 检查服务器 TPS 是否正常
3. 检查网络连接是否稳定

### 高延迟玩家体验差

启用延迟补偿：

```yaml
# paper-global.yml
misc:
  lag-compensate-block-breaking: true
```

### 代理服务器无法连接

1. 确认代理配置正确
2. 检查密钥是否匹配
3. 确认防火墙设置允许连接
